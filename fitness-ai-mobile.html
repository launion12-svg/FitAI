<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitAI - Tu Entrenador Personal</title>
    <style>
        :root {
            --pri: #667eea;
            --pri2: #764ba2;
            --ok: #10b981;
            --warn: #f59e0b;
            --err: #ef4444;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #e0e0e0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0b0b0f;
                --card-bg: #14141a;
                --text: #e6e6ea;
                --text-light: #9ca3af;
                --border: #262636;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* Focus visible para accesibilidad */
        :focus-visible {
            outline: 3px solid var(--pri2);
            outline-offset: 2px;
        }

        button:focus-visible,
        a:focus-visible {
            outline: 3px solid var(--pri2);
            outline-offset: 2px;
        }

        /* Mejora de contraste en chips */
        .exercise-number {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
        }

        .hidden {
            display: none !important;
        }

        /* Semantic HTML improvements */
        main {
            min-height: 100vh;
        }

        header {
            position: relative;
        }

        /* Accessibility - Form errors */
        #formErrors {
            background: var(--err);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        #formErrors.hidden {
            display: none;
        }

        /* Welcome Screen */
        .welcome-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .welcome-screen h1 {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .welcome-screen p {
            font-size: 1.2rem;
            margin-bottom: 15px;
            opacity: 0.95;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 30px 0;
            max-width: 500px;
            width: 100%;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            text-align: left;
        }

        .feature-card h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .btn-primary {
            background: white;
            color: var(--pri);
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-primary:focus-visible {
            outline: 3px solid white;
            outline-offset: 2px;
        }

        /* Form Screen */
        .form-screen {
            min-height: 100vh;
            padding: 20px;
            background: #f5f5f5;
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-header {
            margin-bottom: 25px;
        }

        .form-header h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .progress-bar {
            display: flex;
            gap: 5px;
            margin-top: 15px;
        }

        .progress-segment {
            height: 6px;
            flex: 1;
            background: #e0e0e0;
            border-radius: 3px;
            transition: background 0.3s;
        }

        .progress-segment.active {
            background: #667eea;
        }

        .form-page {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .checkbox-label input {
            width: auto;
            margin-right: 8px;
        }

        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 10px;
        }

        .btn-secondary {
            padding: 12px 30px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-next {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
        }

        /* Dashboard */
        .dashboard {
            min-height: 100vh;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }

        .dashboard-header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .tabs {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab {
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.95rem;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            color: var(--text-light);
        }

        .tab[aria-selected="true"] {
            color: var(--pri);
            border-bottom-color: var(--pri);
            font-weight: 600;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab:focus-visible {
            outline: 3px solid var(--pri2);
            outline-offset: -3px;
        }

        .dashboard-content {
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--text);
        }

        .card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--text);
        }

        /* Exercise Plan */
        .day-selector {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .day-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }

        .day-btn.active {
            background: #667eea;
            color: white;
        }

        .exercise-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .exercise-item:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .exercise-number {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .exercise-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .exercise-details {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }

        .detail-item {
            display: flex;
            gap: 5px;
        }

        .detail-label {
            color: #999;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
        }

        .speak-btn {
            background: #f0e7ff;
            color: #667eea;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .speak-btn.speaking {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Nutrition Plan */
        .macro-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .macro-card {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .macro-card.calories { background: #f3e8ff; color: #7c3aed; }
        .macro-card.protein { background: #dbeafe; color: #2563eb; }
        .macro-card.carbs { background: #d1fae5; color: #059669; }
        .macro-card.fat { background: #fef3c7; color: #d97706; }

        .macro-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .macro-label {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .meal-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .meal-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .meal-time {
            color: #666;
            font-size: 0.9rem;
        }

        .meal-calories {
            background: #f0e7ff;
            color: #667eea;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .food-list {
            margin-top: 10px;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }

        .food-item:last-child {
            border-bottom: none;
        }

        .food-name {
            font-weight: 500;
        }

        .food-amount {
            color: #666;
        }

        .food-store {
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 5px;
        }

        /* Shopping List */
        .shopping-category {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shopping-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .shopping-item.checked {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .shopping-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .item-store {
            font-size: 0.85rem;
            color: #666;
        }

        .item-price {
            font-weight: 600;
            color: #667eea;
        }

        .shopping-item.checked .item-name {
            text-decoration: line-through;
            color: #999;
        }

        .shopping-item.checked .item-price {
            color: #999;
        }

        .total-price {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .total-price .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .total-price .amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 5px 0;
        }

        /* Chat */
        .chat-container {
            height: 500px;
            overflow-y: auto;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
        }

        .chat-message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .chat-message.user .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant .message-bubble {
            background: white;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .chat-loading {
            display: flex;
            gap: 5px;
            padding: 12px 16px;
        }

        .chat-loading .dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .chat-loading .dot:nth-child(1) { animation-delay: -0.32s; }
        .chat-loading .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .quick-questions {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            margin-bottom: 15px;
            padding-bottom: 10px;
        }

        .quick-btn {
            background: #f0e7ff;
            color: #667eea;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            white-space: nowrap;
            cursor: pointer;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .alert {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        /* Progress */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .stat-unit {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Workout Logger */
        .exercise-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .exercise-completed {
            background: #d1fae5 !important;
            border-color: #86efac !important;
        }

        .set-logger {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .set-input {
            width: 70px;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85rem;
            text-align: center;
        }

        .set-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn-complete-set {
            padding: 6px 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-complete-set:active {
            background: #059669;
        }

        .set-completed {
            background: #d1fae5;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #047857;
            border: 1px solid #86efac;
        }

        /* Rest Timer */
        .timer-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
            min-width: 280px;
        }

        .timer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .timer-display {
            font-size: 4rem;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }

        .timer-progress {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 1s linear;
        }

        .timer-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .timer-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }

        .timer-btn-start {
            background: #10b981;
            color: white;
        }

        .timer-btn-pause {
            background: #f59e0b;
            color: white;
        }

        .timer-btn-stop {
            background: #ef4444;
            color: white;
        }

        /* Water Tracker */
        .water-tracker {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .water-glasses {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .water-glass {
            aspect-ratio: 1;
            border: 3px solid white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
        }

        .water-glass.filled {
            background: rgba(255,255,255,0.4);
            transform: scale(1.1);
        }

        .water-glass:active {
            transform: scale(0.95);
        }

        /* Food Logger */
        .meal-logger {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .meal-logger.logged {
            border-color: #86efac;
            background: #f0fdf4;
        }

        .log-meal-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .meal-logged-badge {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Stats Cards */
        .stat-card-mini {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card-mini .label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-card-mini .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card-mini .unit {
            font-size: 0.9rem;
            color: #999;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            font-size: 1.5rem;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Animations */
        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .celebrate {
            animation: celebrate 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        /* Weekly Calendar */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 10px;
        }

        .view-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .weekly-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .day-cell {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-cell.active {
            border-color: #667eea;
            background: #f0e7ff;
        }

        .day-cell.rest {
            background: #f9f9f9;
            border-color: #f0f0f0;
        }

        .day-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .day-icon {
            font-size: 1.5rem;
            margin: 5px 0;
        }

        .day-label {
            font-size: 0.65rem;
            color: #999;
            margin-top: 5px;
        }

        .weekly-overview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .weekly-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .weekly-stat {
            text-align: center;
        }

        .weekly-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .weekly-stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .nutrition-week-grid {
            display: grid;
            gap: 15px;
        }

        .day-nutrition-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-nutrition-card.active {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .day-nutrition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .day-nutrition-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .day-nutrition-cals {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .mini-macro-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .mini-macro {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .mini-macro.protein { background: #dbeafe; color: #2563eb; }
        .mini-macro.carbs { background: #d1fae5; color: #059669; }
        .mini-macro.fat { background: #fef3c7; color: #d97706; }

        .mini-macro-value {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .meal-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .meal-tag {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            color: #666;
        }

        @media (max-width: 640px) {
            .form-row,
            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .macro-grid {
                grid-template-columns: 1fr 1fr;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Estado global de la aplicaci√≥n
        const appState = {
            currentScreen: 'welcome',
            currentFormPage: 1,
            currentTab: 'ejercicios',
            selectedDay: 0,
            exerciseView: 'day', // 'day' o 'week'
            nutritionView: 'day', // 'day' o 'week'
            selectedWeekDay: 0,
            showApiModal: false,
            userData: {},
            userPlan: null,
            apiKey: '',
            chatMessages: [],
            isLoading: false,
            progresoHistorial: [],
            ultimaActualizacion: null,
            recordatoriosPendientes: [],
            // Workout Logger
            workoutHistory: [],
            currentWorkout: null,
            todayWorkout: null,
            // Daily Tracking
            dailyTracking: {
                date: new Date().toDateString(),
                water: 0, // vasos de agua
                meals: {}, // comidas registradas
                caloriesConsumed: 0,
                exerciseCompleted: false
            },
            // Timer
            restTimer: {
                active: false,
                timeLeft: 0,
                totalTime: 0,
                isPaused: false
            },
            // Stats
            stats: {
                totalWorkouts: 0,
                totalCaloriesBurned: 0,
                totalVolumeLifted: 0,
                currentStreak: 0,
                longestStreak: 0,
                averageWorkoutTime: 0
            }
        };

        // Cargar datos guardados al iniciar
        function loadSavedData() {
            const workoutHistory = localStorage.getItem('workout_history');
            if (workoutHistory) {
                appState.workoutHistory = JSON.parse(workoutHistory);
            }
            
            const dailyTracking = localStorage.getItem('daily_tracking');
            if (dailyTracking) {
                const saved = JSON.parse(dailyTracking);
                // Solo cargar si es del d√≠a actual
                if (saved.date === new Date().toDateString()) {
                    appState.dailyTracking = saved;
                }
            }
            
            const stats = localStorage.getItem('stats');
            if (stats) {
                appState.stats = JSON.parse(stats);
            }
            
            // Cargar workout de hoy si existe
            loadTodayWorkout();
        }

        function loadTodayWorkout() {
            const today = new Date().toLocaleDateString('es-ES', { weekday: 'long' });
            const todayCapitalized = today.charAt(0).toUpperCase() + today.slice(1);
            
            if (appState.userPlan && appState.userPlan.planEjercicios) {
                const todayPlan = appState.userPlan.planEjercicios.semanaCompleta?.find(
                    d => d.dia === todayCapitalized
                );
                
                if (todayPlan && todayPlan.tipo === 'entrenamiento') {
                    // Verificar si ya hay un workout iniciado hoy
                    const existingWorkout = appState.workoutHistory.find(w => 
                        new Date(w.date).toDateString() === new Date().toDateString() && !w.completed
                    );
                    
                    if (existingWorkout) {
                        appState.currentWorkout = existingWorkout;
                    } else {
                        appState.todayWorkout = todayPlan;
                    }
                }
            }
        }

        // Sistema de recordatorios
        function checkReminders() {
            const lastUpdate = localStorage.getItem('ultima_actualizacion');
            const reminderInterval = 14; // d√≠as
            
            if (lastUpdate) {
                const daysSinceUpdate = Math.floor((Date.now() - new Date(lastUpdate)) / (1000 * 60 * 60 * 24));
                
                if (daysSinceUpdate >= reminderInterval) {
                    return {
                        show: true,
                        days: daysSinceUpdate,
                        message: `Han pasado ${daysSinceUpdate} d√≠as desde tu √∫ltima actualizaci√≥n`
                    };
                }
            }
            return { show: false };
        }

        // ===== WORKOUT LOGGER FUNCTIONS =====
        
        function startWorkout(dayPlan) {
            const workout = {
                id: `workout_${Date.now()}`,
                date: new Date().toISOString(),
                dayName: dayPlan.dia,
                planType: dayPlan.enfoque,
                exercises: dayPlan.ejercicios.map(ej => ({
                    name: ej.nombre,
                    targetSets: ej.series,
                    targetReps: ej.repeticiones,
                    restTime: parseInt(ej.descanso) || 60,
                    sets: [],
                    completed: false,
                    description: ej.descripcion
                })),
                startTime: Date.now(),
                totalVolume: 0,
                duration: 0,
                caloriesBurned: 0,
                completed: false
            };
            
            appState.currentWorkout = workout;
            localStorage.setItem('current_workout', JSON.stringify(workout));
            render();
        }

        function addSet(exerciseIndex, peso, reps) {
            if (!appState.currentWorkout) return;
            
            const exercise = appState.currentWorkout.exercises[exerciseIndex];
            exercise.sets.push({
                peso: parseFloat(peso) || 0,
                reps: parseInt(reps) || 0,
                timestamp: Date.now()
            });
            
            // Calcular volumen
            const volume = exercise.sets.reduce((sum, set) => sum + (set.peso * set.reps), 0);
            exercise.volume = volume;
            
            // Actualizar volumen total
            appState.currentWorkout.totalVolume = appState.currentWorkout.exercises.reduce(
                (sum, ex) => sum + (ex.volume || 0), 0
            );
            
            localStorage.setItem('current_workout', JSON.stringify(appState.currentWorkout));
            
            // Iniciar timer de descanso
            if (exercise.sets.length < exercise.targetSets) {
                startRestTimer(exercise.restTime);
            }
            
            render();
        }

        function toggleExerciseComplete(exerciseIndex) {
            if (!appState.currentWorkout) return;
            
            const exercise = appState.currentWorkout.exercises[exerciseIndex];
            exercise.completed = !exercise.completed;
            
            if (exercise.completed) {
                // Celebraci√≥n
                showCelebration(`¬°${exercise.name} completado! üí™`);
            }
            
            localStorage.setItem('current_workout', JSON.stringify(appState.currentWorkout));
            render();
        }

        function finishWorkout() {
            if (!appState.currentWorkout) return;
            
            const workout = appState.currentWorkout;
            workout.completed = true;
            workout.endTime = Date.now();
            workout.duration = Math.round((workout.endTime - workout.startTime) / 1000 / 60); // minutos
            
            // Calcular calor√≠as (estimaci√≥n b√°sica)
            const intensityFactor = appState.userData.experienciaGym === 'avanzado' ? 1.2 : 
                                   appState.userData.experienciaGym === 'intermedio' ? 1.0 : 0.8;
            workout.caloriesBurned = Math.round(workout.duration * 6 * intensityFactor);
            
            // Agregar al historial
            if (!appState.workoutHistory) {
                appState.workoutHistory = [];
            }
            appState.workoutHistory.push(workout);
            localStorage.setItem('workout_history', JSON.stringify(appState.workoutHistory));
            
            // Actualizar stats
            updateStats(workout);
            
            // Limpiar workout actual
            appState.currentWorkout = null;
            localStorage.removeItem('current_workout');
            
            // Marcar tracking diario
            appState.dailyTracking.exerciseCompleted = true;
            saveDailyTracking();
            
            showCelebration('üéâ ¬°Entrenamiento completado! ¬°Excelente trabajo!');
            render();
        }

        function updateStats(workout) {
            if (!appState.stats) {
                appState.stats = {
                    totalWorkouts: 0,
                    totalCaloriesBurned: 0,
                    totalVolumeLifted: 0,
                    currentStreak: 0,
                    longestStreak: 0,
                    personalRecords: {}
                };
            }
            
            appState.stats.totalWorkouts++;
            appState.stats.totalCaloriesBurned += workout.caloriesBurned;
            appState.stats.totalVolumeLifted += workout.totalVolume;
            
            // Calcular racha
            updateStreak();
            
            // Actualizar r√©cords personales
            workout.exercises.forEach(exercise => {
                if (exercise.sets.length > 0) {
                    const maxWeight = Math.max(...exercise.sets.map(s => s.peso));
                    const currentPR = appState.stats.personalRecords[exercise.name];
                    
                    if (!currentPR || maxWeight > currentPR.peso) {
                        appState.stats.personalRecords[exercise.name] = {
                            peso: maxWeight,
                            date: workout.date
                        };
                    }
                }
            });
            
            localStorage.setItem('stats', JSON.stringify(appState.stats));
        }

        function updateStreak() {
            const workoutDates = appState.workoutHistory
                .map(w => new Date(w.date).toDateString())
                .sort((a, b) => new Date(b) - new Date(a));
            
            let currentStreak = 0;
            let checkDate = new Date();
            
            for (let i = 0; i < 30; i++) { // Check √∫ltimos 30 d√≠as
                const dateStr = checkDate.toDateString();
                if (workoutDates.includes(dateStr)) {
                    currentStreak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            appState.stats.currentStreak = currentStreak;
            if (currentStreak > appState.stats.longestStreak) {
                appState.stats.longestStreak = currentStreak;
            }
        }

        // ===== REST TIMER FUNCTIONS (mejorado con requestAnimationFrame) =====
        
        let timerStartTime = null;
        let timerAnimationFrame = null;
        
        function startRestTimer(seconds) {
            appState.restTimer = {
                active: true,
                timeLeft: seconds,
                totalTime: seconds,
                isPaused: false,
                targetTime: Date.now() + (seconds * 1000)
            };
            
            timerStartTime = Date.now();
            render();
            tickTimer();
        }

        function tickTimer() {
            if (!appState.restTimer.active) return;
            
            if (!appState.restTimer.isPaused) {
                const now = Date.now();
                const elapsed = Math.floor((now - timerStartTime) / 1000);
                appState.restTimer.timeLeft = Math.max(0, appState.restTimer.totalTime - elapsed);
                
                // Actualizar UI
                const display = document.getElementById('timer-display');
                const progressBar = document.getElementById('timer-progress-bar');
                
                if (display) {
                    const mins = Math.floor(appState.restTimer.timeLeft / 60);
                    const secs = appState.restTimer.timeLeft % 60;
                    display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                }
                
                if (progressBar) {
                    const progress = (appState.restTimer.timeLeft / appState.restTimer.totalTime) * 100;
                    progressBar.style.width = progress + '%';
                }
                
                // Timer terminado
                if (appState.restTimer.timeLeft === 0) {
                    cancelAnimationFrame(timerAnimationFrame);
                    playSound();
                    vibrate();
                    showNotification('‚è∞ ¬°Descanso terminado! Siguiente serie');
                    
                    setTimeout(() => {
                        appState.restTimer.active = false;
                        render();
                    }, 2000);
                    return;
                }
            }
            
            timerAnimationFrame = requestAnimationFrame(tickTimer);
        }

        function pauseRestTimer() {
            if (appState.restTimer.isPaused) {
                // Reanudar
                const pausedTime = appState.restTimer.timeLeft;
                timerStartTime = Date.now();
                appState.restTimer.totalTime = pausedTime;
            }
            appState.restTimer.isPaused = !appState.restTimer.isPaused;
            render();
        }

        function stopRestTimer() {
            cancelAnimationFrame(timerAnimationFrame);
            appState.restTimer.active = false;
            render();
        }

        function playSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBzaM0/LTgjMGHm7A7+OZSBDM0v//');
                audio.play().catch(() => {});
            } catch (e) {}
        }

        function vibrate() {
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        function showNotification(message) {
            // Toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: #10b981;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 9999;
                font-weight: 600;
                animation: slideDown 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showCelebration(message) {
            showNotification(message);
            vibrate();
        }

        // ===== WATER TRACKER FUNCTIONS =====
        
        function addWaterGlass() {
            if (appState.dailyTracking.water < 8) {
                appState.dailyTracking.water++;
                saveDailyTracking();
                
                if (appState.dailyTracking.water === 8) {
                    showCelebration('üíß ¬°Objetivo de hidrataci√≥n cumplido!');
                }
                
                render();
            }
        }

        function removeWaterGlass() {
            if (appState.dailyTracking.water > 0) {
                appState.dailyTracking.water--;
                saveDailyTracking();
                render();
            }
        }

        // ===== FOOD LOGGER FUNCTIONS =====
        
        function logMeal(mealId, calorias) {
            if (!appState.dailyTracking.meals[mealId]) {
                appState.dailyTracking.meals[mealId] = {
                    logged: true,
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    calorias: calorias
                };
                
                appState.dailyTracking.caloriesConsumed += calorias;
                saveDailyTracking();
                
                showNotification(`‚úÖ ${mealId.replace('_', ' ')} registrada`);
                render();
            }
        }

        function saveDailyTracking() {
            appState.dailyTracking.date = new Date().toDateString();
            localStorage.setItem('daily_tracking', JSON.stringify(appState.dailyTracking));
        }

        // ===== HELPER FUNCTIONS =====
        
        function checkAndResetDailyTracking() {
            const today = new Date().toDateString();
            if (appState.dailyTracking.date !== today) {
                appState.dailyTracking = {
                    date: today,
                    water: 0,
                    meals: {},
                    caloriesConsumed: 0,
                    exerciseCompleted: false
                };
                saveDailyTracking();
            }
        }

        // Cargar historial de progreso
        function loadProgressHistory() {
            const historial = localStorage.getItem('progreso_historial');
            if (historial) {
                appState.progresoHistorial = JSON.parse(historial);
            }
        }

        // Guardar medici√≥n de progreso
        function saveProgressUpdate(peso, medidas, foto) {
            const update = {
                fecha: new Date().toISOString(),
                peso: peso,
                medidas: medidas,
                foto: foto || null,
                tipo: 'seguimiento'
            };
            
            if (!appState.progresoHistorial) {
                appState.progresoHistorial = [];
            }
            
            appState.progresoHistorial.push(update);
            localStorage.setItem('progreso_historial', JSON.stringify(appState.progresoHistorial));
            localStorage.setItem('ultima_actualizacion', new Date().toISOString());
            
            // Aqu√≠ se podr√≠a llamar a la IA para analizar el progreso y ajustar el plan
            analyzeProgressWithAI(update);
        }

        // Analizar progreso con IA y sugerir ajustes
        async function analyzeProgressWithAI(currentUpdate) {
            const apiKey = localStorage.getItem('gemini_api_key');
            
            if (!apiKey || appState.progresoHistorial.length < 2) {
                return; // Necesitamos al menos 2 mediciones para comparar
            }

            try {
                const historial = appState.progresoHistorial.slice(-5); // √öltimas 5 mediciones
                const primeraMedicion = historial[0];
                const ultimaMedicion = currentUpdate;
                
                const pesoInicial = parseFloat(primeraMedicion.peso);
                const pesoActual = parseFloat(ultimaMedicion.peso);
                const diferenciaPeso = pesoActual - pesoInicial;
                const tiempoTranscurrido = Math.floor((new Date(ultimaMedicion.fecha) - new Date(primeraMedicion.fecha)) / (1000 * 60 * 60 * 24));

                const prompt = `Como entrenador personal experto, analiza el progreso del usuario y sugiere ajustes.

DATOS DEL USUARIO:
- Objetivo: ${appState.userData.objetivo}
- Peso inicial: ${pesoInicial}kg
- Peso actual: ${pesoActual}kg
- Diferencia: ${diferenciaPeso > 0 ? '+' : ''}${diferenciaPeso.toFixed(1)}kg
- Tiempo transcurrido: ${tiempoTranscurrido} d√≠as
- Medidas iniciales: Pecho ${primeraMedicion.medidas?.pecho || '-'}cm, Cintura ${primeraMedicion.medidas?.cintura || '-'}cm, Cadera ${primeraMedicion.medidas?.cadera || '-'}cm
- Medidas actuales: Pecho ${ultimaMedicion.medidas?.pecho || '-'}cm, Cintura ${ultimaMedicion.medidas?.cintura || '-'}cm, Cadera ${ultimaMedicion.medidas?.cadera || '-'}cm

AN√ÅLISIS REQUERIDO:
1. ¬øEl progreso es adecuado para el objetivo?
2. ¬øNecesita ajustar calor√≠as? (aumentar/disminuir/mantener)
3. ¬øNecesita ajustar intensidad de entrenamiento?
4. ¬øHay se√±ales de estancamiento o progreso excesivo?
5. Recomendaciones espec√≠ficas

Responde en formato JSON:
{
  "analisis": "an√°lisis breve del progreso",
  "progresaAdecuadamente": true/false,
  "ajusteCalorias": "aumentar/disminuir/mantener",
  "ajusteEntrenamiento": "aumentar_intensidad/mantener/reducir",
  "recomendaciones": ["recomendaci√≥n 1", "recomendaci√≥n 2", "recomendaci√≥n 3"],
  "motivacion": "mensaje motivador personalizado"
}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1024
                        }
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    let textResponse = data.candidates[0].content.parts[0].text;
                    textResponse = textResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    const analisis = JSON.parse(textResponse);
                    
                    // Guardar an√°lisis
                    ultimaMedicion.analisisIA = analisis;
                    localStorage.setItem('progreso_historial', JSON.stringify(appState.progresoHistorial));
                    
                    // Mostrar notificaci√≥n al usuario
                    mostrarNotificacionProgreso(analisis);
                    
                    // Si necesita ajustes significativos, sugerir regenerar plan
                    if (analisis.ajusteCalorias !== 'mantener' || analisis.ajusteEntrenamiento !== 'mantener') {
                        mostrarSugerenciaAjustePlan(analisis);
                    }
                }
            } catch (error) {
                console.error('Error analizando progreso:', error);
            }
        }

        function mostrarNotificacionProgreso(analisis) {
            // Mostrar modal o notificaci√≥n con el an√°lisis
            appState.notificacionProgreso = analisis;
            render();
        }

        function mostrarSugerenciaAjustePlan(analisis) {
            const mensaje = `üîÑ Bas√°ndome en tu progreso, recomiendo ajustar tu plan:\n\n` +
                `üìä Calor√≠as: ${analisis.ajusteCalorias}\n` +
                `üí™ Entrenamiento: ${analisis.ajusteEntrenamiento}\n\n` +
                `${analisis.analisis}\n\n` +
                `¬øQuieres que regenere tu plan con estos ajustes?`;
            
            if (confirm(mensaje)) {
                regeneratePlansWithAdjustments(analisis);
            }
        }

        async function regeneratePlansWithAdjustments(analisis) {
            // Ajustar userData seg√∫n recomendaciones
            if (analisis.ajusteCalorias === 'aumentar') {
                // L√≥gica para aumentar calor√≠as
            } else if (analisis.ajusteCalorias === 'disminuir') {
                // L√≥gica para disminuir calor√≠as
            }
            
            // Regenerar planes
            await generatePlanWithAI();
            alert('‚úÖ Plan actualizado seg√∫n tu progreso!');
        }

        // Plan de ejemplo (simulado)
        const mockPlan = {
            planEjercicios: {
                semanaCompleta: [
                    {
                        dia: 'Lunes',
                        enfoque: 'Tren Superior',
                        tipo: 'entrenamiento',
                        ejercicios: [
                            { nombre: 'Press de banca', series: 4, repeticiones: '8-12', descanso: '90s', descripcion: 'Ejercicio fundamental para pecho' },
                            { nombre: 'Remo con barra', series: 4, repeticiones: '8-12', descanso: '90s', descripcion: 'Para desarrollo de espalda' },
                            { nombre: 'Press militar', series: 3, repeticiones: '10-12', descanso: '60s', descripcion: 'Fortalece hombros' },
                            { nombre: 'Curl de b√≠ceps', series: 3, repeticiones: '12-15', descanso: '60s', descripcion: 'Aislamiento de b√≠ceps' }
                        ]
                    },
                    {
                        dia: 'Martes',
                        tipo: 'descanso',
                        descripcion: 'D√≠a de descanso activo. Puedes hacer estiramientos suaves o una caminata de 20-30 minutos.'
                    },
                    {
                        dia: 'Mi√©rcoles',
                        enfoque: 'Tren Inferior',
                        tipo: 'entrenamiento',
                        ejercicios: [
                            { nombre: 'Sentadillas', series: 4, repeticiones: '8-12', descanso: '2min', descripcion: 'Ejercicio rey para piernas' },
                            { nombre: 'Peso muerto rumano', series: 4, repeticiones: '8-10', descanso: '2min', descripcion: 'Para femoral y gl√∫teo' },
                            { nombre: 'Prensa de piernas', series: 3, repeticiones: '12-15', descanso: '90s', descripcion: 'Cu√°driceps y gl√∫teos' },
                            { nombre: 'Curl femoral', series: 3, repeticiones: '12-15', descanso: '60s', descripcion: 'Aislamiento femoral' }
                        ]
                    },
                    {
                        dia: 'Jueves',
                        tipo: 'descanso',
                        descripcion: 'Descanso o cardio ligero (bicicleta, nataci√≥n). Mantente activo pero sin entrenar fuerza.'
                    },
                    {
                        dia: 'Viernes',
                        enfoque: 'Full Body',
                        tipo: 'entrenamiento',
                        ejercicios: [
                            { nombre: 'Dominadas', series: 3, repeticiones: 'al fallo', descanso: '2min', descripcion: 'Espalda y brazos' },
                            { nombre: 'Fondos en paralelas', series: 3, repeticiones: 'al fallo', descanso: '2min', descripcion: 'Pecho y tr√≠ceps' },
                            { nombre: 'Zancadas', series: 3, repeticiones: '12 por pierna', descanso: '90s', descripcion: 'Piernas y equilibrio' },
                            { nombre: 'Plancha abdominal', series: 3, repeticiones: '60s', descanso: '60s', descripcion: 'Core completo' }
                        ]
                    },
                    {
                        dia: 'S√°bado',
                        tipo: 'descanso',
                        descripcion: 'Descanso completo o yoga/movilidad para recuperaci√≥n activa.'
                    },
                    {
                        dia: 'Domingo',
                        tipo: 'descanso',
                        descripcion: 'Descanso total. Prepara tu semana, haz meal prep y descansa bien.'
                    }
                ],
                dias: [
                    {
                        dia: 'Lunes',
                        enfoque: 'Tren Superior',
                        ejercicios: [
                            { nombre: 'Press de banca', series: 4, repeticiones: '8-12', descanso: '90s', descripcion: 'Ejercicio fundamental para pecho' },
                            { nombre: 'Remo con barra', series: 4, repeticiones: '8-12', descanso: '90s', descripcion: 'Para desarrollo de espalda' },
                            { nombre: 'Press militar', series: 3, repeticiones: '10-12', descanso: '60s', descripcion: 'Fortalece hombros' },
                            { nombre: 'Curl de b√≠ceps', series: 3, repeticiones: '12-15', descanso: '60s', descripcion: 'Aislamiento de b√≠ceps' }
                        ]
                    },
                    {
                        dia: 'Mi√©rcoles',
                        enfoque: 'Tren Inferior',
                        ejercicios: [
                            { nombre: 'Sentadillas', series: 4, repeticiones: '8-12', descanso: '2min', descripcion: 'Ejercicio rey para piernas' },
                            { nombre: 'Peso muerto rumano', series: 4, repeticiones: '8-10', descanso: '2min', descripcion: 'Para femoral y gl√∫teo' },
                            { nombre: 'Prensa de piernas', series: 3, repeticiones: '12-15', descanso: '90s', descripcion: 'Cu√°driceps y gl√∫teos' },
                            { nombre: 'Curl femoral', series: 3, repeticiones: '12-15', descanso: '60s', descripcion: 'Aislamiento femoral' }
                        ]
                    },
                    {
                        dia: 'Viernes',
                        enfoque: 'Full Body',
                        ejercicios: [
                            { nombre: 'Dominadas', series: 3, repeticiones: 'al fallo', descanso: '2min', descripcion: 'Espalda y brazos' },
                            { nombre: 'Fondos en paralelas', series: 3, repeticiones: 'al fallo', descanso: '2min', descripcion: 'Pecho y tr√≠ceps' },
                            { nombre: 'Zancadas', series: 3, repeticiones: '12 por pierna', descanso: '90s', descripcion: 'Piernas y equilibrio' },
                            { nombre: 'Plancha abdominal', series: 3, repeticiones: '60s', descanso: '60s', descripcion: 'Core completo' }
                        ]
                    }
                ]
            },
            planNutricion: {
                calorias: 2200,
                proteinas: 165,
                carbohidratos: 220,
                grasas: 73,
                comidas: [
                    {
                        momento: 'Desayuno',
                        hora: '8:00',
                        alimentos: [
                            { nombre: 'Avena Hacendado', cantidad: '80g', tienda: 'Mercadona', calorias: 304 },
                            { nombre: 'Pl√°tano', cantidad: '1 unidad', tienda: 'Cualquiera', calorias: 105 },
                            { nombre: 'Leche desnatada', cantidad: '250ml', tienda: 'Mercadona', calorias: 85 }
                        ]
                    },
                    {
                        momento: 'Media Ma√±ana',
                        hora: '11:00',
                        alimentos: [
                            { nombre: 'Yogur griego', cantidad: '200g', tienda: 'Mercadona', calorias: 130 },
                            { nombre: 'Manzana', cantidad: '1 unidad', tienda: 'Cualquiera', calorias: 95 }
                        ]
                    },
                    {
                        momento: 'Comida',
                        hora: '14:00',
                        alimentos: [
                            { nombre: 'Pechuga de pollo', cantidad: '200g', tienda: 'Mercadona', calorias: 330 },
                            { nombre: 'Arroz integral', cantidad: '100g', tienda: 'Eroski', calorias: 350 },
                            { nombre: 'Br√≥coli', cantidad: '200g', tienda: 'Cualquiera', calorias: 68 }
                        ]
                    },
                    {
                        momento: 'Merienda',
                        hora: '17:30',
                        alimentos: [
                            { nombre: 'Pan integral', cantidad: '2 rebanadas', tienda: 'Mercadona', calorias: 140 },
                            { nombre: 'Pavo', cantidad: '60g', tienda: 'Mercadona', calorias: 72 }
                        ]
                    },
                    {
                        momento: 'Cena',
                        hora: '21:00',
                        alimentos: [
                            { nombre: 'Salm√≥n', cantidad: '150g', tienda: 'Aldi', calorias: 312 },
                            { nombre: 'Patata al horno', cantidad: '200g', tienda: 'Cualquiera', calorias: 154 },
                            { nombre: 'Esp√°rragos', cantidad: '150g', tienda: 'Mercadona', calorias: 30 }
                        ]
                    }
                ],
                listaCompra: {
                    'Prote√≠nas': [
                        { item: 'Pechuga de pollo (1.4kg)', tienda: 'Mercadona', precio: '8.40‚Ç¨' },
                        { item: 'Salm√≥n (1kg)', tienda: 'Aldi', precio: '7.99‚Ç¨' },
                        { item: 'Pavo (400g)', tienda: 'Mercadona', precio: '3.20‚Ç¨' }
                    ],
                    'Carbohidratos': [
                        { item: 'Avena (1kg)', tienda: 'Mercadona', precio: '1.80‚Ç¨' },
                        { item: 'Arroz integral (1kg)', tienda: 'Eroski', precio: '2.20‚Ç¨' },
                        { item: 'Pan integral', tienda: 'Mercadona', precio: '1.50‚Ç¨' }
                    ],
                    'Frutas y Verduras': [
                        { item: 'Pl√°tanos (1.5kg)', tienda: 'Cualquiera', precio: '2.25‚Ç¨' },
                        { item: 'Manzanas (1.5kg)', tienda: 'Cualquiera', precio: '2.70‚Ç¨' },
                        { item: 'Br√≥coli (1kg)', tienda: 'Mercadona', precio: '2.50‚Ç¨' }
                    ],
                    'L√°cteos': [
                        { item: 'Leche desnatada (6L)', tienda: 'Mercadona', precio: '4.20‚Ç¨' },
                        { item: 'Yogur griego (pack 4)', tienda: 'Mercadona', precio: '3.60‚Ç¨' }
                    ]
                }
            }
        };

        // Funciones de renderizado
        function render() {
            const app = document.getElementById('app');
            
            if (appState.currentScreen === 'welcome') {
                app.innerHTML = renderWelcome();
            } else if (appState.currentScreen === 'form') {
                app.innerHTML = renderForm();
            } else if (appState.currentScreen === 'dashboard') {
                app.innerHTML = renderDashboard();
            }

            attachEventListeners();
        }

        function renderWelcome() {
            return `
                <div class="welcome-screen">
                    <h1>üí™ FitAI</h1>
                    <p style="font-size: 1.5rem; margin-bottom: 10px;">Tu Entrenador Personal con IA</p>
                    <p>Planes personalizados de ejercicios y nutrici√≥n</p>
                    
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h3>üèãÔ∏è Plan de Ejercicios</h3>
                            <p style="font-size: 0.9rem; opacity: 0.9;">Rutinas personalizadas para gimnasio o casa</p>
                        </div>
                        <div class="feature-card">
                            <h3>ü•ó Plan de Nutrici√≥n</h3>
                            <p style="font-size: 0.9rem; opacity: 0.9;">Men√∫s con productos de supermercados espa√±oles</p>
                        </div>
                        <div class="feature-card">
                            <h3>üõí Lista de Compra</h3>
                            <p style="font-size: 0.9rem; opacity: 0.9;">Organizada por categor√≠as</p>
                        </div>
                        <div class="feature-card">
                            <h3>üí¨ Chat con IA</h3>
                            <p style="font-size: 0.9rem; opacity: 0.9;">Consulta dudas 24/7</p>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="startApp()">Comenzar Ahora</button>
                </div>
            `;
        }

        function renderForm() {
            const page = appState.currentFormPage;
            
            return `
                <div class="form-screen">
                    <div class="form-container">
                        <div id="formErrors" role="alert" aria-live="assertive" class="hidden"></div>
                        
                        <div class="form-header">
                            <h2>Cu√©ntanos sobre ti</h2>
                            <p style="color: #666; font-size: 0.9rem;">P√°gina ${page} de 3</p>
                            <div class="progress-bar">
                                <div class="progress-segment ${page >= 1 ? 'active' : ''}"></div>
                                <div class="progress-segment ${page >= 2 ? 'active' : ''}"></div>
                                <div class="progress-segment ${page >= 3 ? 'active' : ''}"></div>
                            </div>
                        </div>
                        
                        ${page === 1 ? renderFormPage1() : ''}
                        ${page === 2 ? renderFormPage2() : ''}
                        ${page === 3 ? renderFormPage3() : ''}
                        
                        <div class="form-buttons">
                            ${page > 1 ? '<button class="btn-secondary" onclick="prevPage()">Anterior</button>' : ''}
                            ${page < 3 
                                ? `<button class="btn-next" onclick="nextPage()">Siguiente</button>`
                                : `<button class="btn-next" onclick="submitForm()">Generar Mi Plan üöÄ</button>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFormPage1() {
            return `
                <div class="form-page">
                    <h3 style="margin-bottom: 20px; color: #555;">Informaci√≥n Personal</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Los campos con <span style="color: #ef4444;">*</span> son obligatorios</p>
                    
                    <div class="form-group">
                        <label>Nombre <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="nombre" placeholder="Tu nombre" value="${appState.userData.nombre || ''}" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Edad <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="edad" placeholder="a√±os" value="${appState.userData.edad || ''}" min="15" max="100" required>
                        </div>
                        <div class="form-group">
                            <label>G√©nero <span style="color: #ef4444;">*</span></label>
                            <select id="genero" required>
                                <option value="">Seleccionar</option>
                                <option value="masculino" ${appState.userData.genero === 'masculino' ? 'selected' : ''}>Masculino</option>
                                <option value="femenino" ${appState.userData.genero === 'femenino' ? 'selected' : ''}>Femenino</option>
                                <option value="otro" ${appState.userData.genero === 'otro' ? 'selected' : ''}>Otro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Peso (kg) <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="peso" placeholder="70" value="${appState.userData.peso || ''}" min="30" max="300" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Altura (cm) <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="altura" placeholder="175" value="${appState.userData.altura || ''}" min="100" max="250" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>¬øTienes alguna lesi√≥n o limitaci√≥n? <span style="color: #999; font-weight: normal;">(opcional)</span></label>
                        <textarea
                            id="lesiones"
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: inherit; min-height: 80px;"
                            placeholder="Ejemplo: dolor lumbar, problemas de rodilla..."
                        >${appState.userData.lesiones || ''}</textarea>
                    </div>
                    
                    <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; padding: 20px; margin-top: 20px;">
                        <h4 style="color: #059669; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            üìè Medidas Corporales 
                            <span style="font-size: 0.85rem; font-weight: normal; color: #047857;">(opcional pero recomendado)</span>
                        </h4>
                        <p style="font-size: 0.9rem; color: #047857; margin-bottom: 15px;">
                            Estas medidas nos ayudar√°n a personalizar mejor tu plan y hacer seguimiento de tu progreso
                        </p>
                        
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.9rem;">Pecho (cm)</label>
                                <input type="number" id="medida_pecho" placeholder="90" value="${appState.userData.medidas?.pecho || ''}" min="50" max="200" step="0.1">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.9rem;">Cintura (cm)</label>
                                <input type="number" id="medida_cintura" placeholder="80" value="${appState.userData.medidas?.cintura || ''}" min="40" max="200" step="0.1">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.9rem;">Cadera (cm)</label>
                                <input type="number" id="medida_cadera" placeholder="95" value="${appState.userData.medidas?.cadera || ''}" min="50" max="200" step="0.1">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.9rem;">Brazo (cm)</label>
                                <input type="number" id="medida_brazo" placeholder="30" value="${appState.userData.medidas?.brazo || ''}" min="15" max="80" step="0.1">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
                            <label style="font-size: 0.9rem;">Foto inicial <span style="color: #666; font-weight: normal;">(opcional)</span></label>
                            <input type="file" id="foto_inicial" accept="image/*" capture="environment" 
                                   style="width: 100%; padding: 10px; border: 2px dashed #86efac; border-radius: 8px; background: white; font-size: 0.9rem;">
                            <p style="font-size: 0.75rem; color: #047857; margin-top: 5px;">
                                üí° Sube una foto para comparar tu progreso m√°s adelante
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFormPage2() {
            return `
                <div class="form-page">
                    <h3 style="margin-bottom: 20px; color: #555;">Objetivos y Actividad</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Los campos con <span style="color: #ef4444;">*</span> son obligatorios</p>
                    
                    <div class="form-group">
                        <label>¬øCu√°l es tu objetivo principal? <span style="color: #ef4444;">*</span></label>
                        <select id="objetivo" required>
                            <option value="">Seleccionar</option>
                            <option value="perder_peso" ${appState.userData.objetivo === 'perder_peso' ? 'selected' : ''}>Perder peso / Definir</option>
                            <option value="ganar_musculo" ${appState.userData.objetivo === 'ganar_musculo' ? 'selected' : ''}>Ganar m√∫sculo</option>
                            <option value="mantenimiento" ${appState.userData.objetivo === 'mantenimiento' ? 'selected' : ''}>Mantener peso</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Nivel de actividad actual <span style="color: #ef4444;">*</span></label>
                        <select id="nivelActividad" required>
                            <option value="">Seleccionar</option>
                            <option value="sedentario" ${appState.userData.nivelActividad === 'sedentario' ? 'selected' : ''}>Sedentario</option>
                            <option value="ligero" ${appState.userData.nivelActividad === 'ligero' ? 'selected' : ''}>Ligeramente activo</option>
                            <option value="moderado" ${appState.userData.nivelActividad === 'moderado' ? 'selected' : ''}>Moderadamente activo</option>
                            <option value="muy_activo" ${appState.userData.nivelActividad === 'muy_activo' ? 'selected' : ''}>Muy activo</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>¬øD√≥nde prefieres entrenar? <span style="color: #ef4444;">*</span></label>
                        <select id="lugarEntrenamiento" required>
                            <option value="">Seleccionar</option>
                            <option value="gimnasio" ${appState.userData.lugarEntrenamiento === 'gimnasio' ? 'selected' : ''}>Gimnasio</option>
                            <option value="casa" ${appState.userData.lugarEntrenamiento === 'casa' ? 'selected' : ''}>Casa</option>
                            <option value="ambos" ${appState.userData.lugarEntrenamiento === 'ambos' ? 'selected' : ''}>Ambos</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>D√≠as de entrenamiento por semana <span style="color: #ef4444;">*</span></label>
                        <select id="diasSemana" required>
                            <option value="">Seleccionar</option>
                            <option value="2" ${appState.userData.diasSemana === '2' ? 'selected' : ''}>2 d√≠as</option>
                            <option value="3" ${appState.userData.diasSemana === '3' ? 'selected' : ''}>3 d√≠as</option>
                            <option value="4" ${appState.userData.diasSemana === '4' ? 'selected' : ''}>4 d√≠as</option>
                            <option value="5" ${appState.userData.diasSemana === '5' ? 'selected' : ''}>5 d√≠as</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="margin-bottom: 12px;">¬øQu√© equipo tienes disponible? <span style="color: #999; font-weight: normal;">(opcional)</span></label>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px;">
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="equipo_mancuernas" ${(appState.userData.equipoDisponible || []).includes('mancuernas') ? 'checked' : ''}>
                                    üèãÔ∏è Mancuernas
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="equipo_barra" ${(appState.userData.equipoDisponible || []).includes('barra') ? 'checked' : ''}>
                                    üí™ Barra con discos
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="equipo_kettlebell" ${(appState.userData.equipoDisponible || []).includes('kettlebell') ? 'checked' : ''}>
                                    ‚ö´ Kettlebell
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="equipo_bandas" ${(appState.userData.equipoDisponible || []).includes('bandas') ? 'checked' : ''}>
                                    üéÄ Bandas el√°sticas
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="equipo_trx" ${(appState.userData.equipoDisponible || []).includes('trx') ? 'checked' : ''}>
                                    üéØ TRX/Suspension
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="equipo_banco" ${(appState.userData.equipoDisponible || []).includes('banco') ? 'checked' : ''}>
                                    ü™ë Banco ajustable
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="equipo_rack" ${(appState.userData.equipoDisponible || []).includes('rack') ? 'checked' : ''}>
                                    üèóÔ∏è Rack/Jaula
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="equipo_barra_dominadas" ${(appState.userData.equipoDisponible || []).includes('barra_dominadas') ? 'checked' : ''}>
                                    üìè Barra dominadas
                                </label>
                            </div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                <p style="font-weight: 600; margin-bottom: 10px; font-size: 0.9rem;">Equipamiento Cardio:</p>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_cinta" ${(appState.userData.equipoDisponible || []).includes('cinta') ? 'checked' : ''}>
                                        üèÉ Cinta de correr
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_bici" ${(appState.userData.equipoDisponible || []).includes('bici') ? 'checked' : ''}>
                                        üö¥ Bicicleta est√°tica
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_eliptica" ${(appState.userData.equipoDisponible || []).includes('eliptica') ? 'checked' : ''}>
                                        ‚≠ï El√≠ptica
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_remo" ${(appState.userData.equipoDisponible || []).includes('remo') ? 'checked' : ''}>
                                        üö£ M√°quina de remo
                                    </label>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                <p style="font-weight: 600; margin-bottom: 10px; font-size: 0.9rem;">Otros:</p>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_colchoneta" ${(appState.userData.equipoDisponible || []).includes('colchoneta') ? 'checked' : ''}>
                                        üßò Colchoneta/Mat
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_step" ${(appState.userData.equipoDisponible || []).includes('step') ? 'checked' : ''}>
                                        üì¶ Step/Caj√≥n
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_balon" ${(appState.userData.equipoDisponible || []).includes('balon') ? 'checked' : ''}>
                                        ‚öΩ Bal√≥n medicinal
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_cuerda" ${(appState.userData.equipoDisponible || []).includes('cuerda') ? 'checked' : ''}>
                                        ü™¢ Cuerda de saltar
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_nada" ${(appState.userData.equipoDisponible || []).includes('nada') ? 'checked' : ''}>
                                        ‚ùå No tengo equipo
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="equipo_exterior" ${(appState.userData.equipoDisponible || []).includes('exterior') ? 'checked' : ''}>
                                        üå≥ Puedo correr/ejercicio exterior
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFormPage3() {
            return `
                <div class="form-page">
                    <h3 style="margin-bottom: 20px; color: #555;">Nutrici√≥n</h3>
                    
                    <div class="form-group">
                        <label>Restricciones alimentarias</label>
                        <select id="restricciones">
                            <option value="ninguna">Ninguna</option>
                            <option value="vegetariano">Vegetariano</option>
                            <option value="vegano">Vegano</option>
                            <option value="sin_gluten">Sin gluten</option>
                            <option value="sin_lactosa">Sin lactosa</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Presupuesto semanal</label>
                        <select id="presupuesto">
                            <option value="">Seleccionar</option>
                            <option value="bajo">Bajo (30-50‚Ç¨)</option>
                            <option value="medio">Medio (50-80‚Ç¨)</option>
                            <option value="alto">Alto (m√°s de 80‚Ç¨)</option>
                        </select>
                    </div>
                    
                    <div style="background: #f0e7ff; border: 1px solid #d8b4fe; border-radius: 10px; padding: 20px; margin-top: 20px;">
                        <h4 style="color: #7c3aed; margin-bottom: 10px;">üìã Resumen</h4>
                        <div style="font-size: 0.9rem; color: #6b21a8;">
                            ${appState.userData.nombre ? `<p><strong>Nombre:</strong> ${appState.userData.nombre}</p>` : ''}
                            ${appState.userData.edad ? `<p><strong>Edad:</strong> ${appState.userData.edad} a√±os</p>` : ''}
                            ${appState.userData.objetivo ? `<p><strong>Objetivo:</strong> ${appState.userData.objetivo.replace('_', ' ')}</p>` : ''}
                            ${appState.userData.diasSemana ? `<p><strong>Entrenamientos:</strong> ${appState.userData.diasSemana} d√≠as/semana</p>` : ''}
                            ${appState.userData.lugarEntrenamiento ? `<p><strong>Lugar:</strong> ${appState.userData.lugarEntrenamiento}</p>` : ''}
                            ${appState.userData.equipoDisponible && appState.userData.equipoDisponible.length > 0 ? `
                                <p><strong>Equipo disponible:</strong></p>
                                <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                    ${appState.userData.equipoDisponible.slice(0, 5).map(eq => `
                                        <span style="background: #c4b5fd; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem;">
                                            ${eq.replace('_', ' ')}
                                        </span>
                                    `).join('')}
                                    ${appState.userData.equipoDisponible.length > 5 ? `
                                        <span style="background: #c4b5fd; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem;">
                                            +${appState.userData.equipoDisponible.length - 5} m√°s
                                        </span>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            return `
                <div class="dashboard">
                    <div class="dashboard-header">
                        <h1>Hola, ${appState.userData.nombre || 'Atleta'}! üí™</h1>
                        <p style="opacity: 0.9;">Tu plan personalizado est√° listo</p>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab ${appState.currentTab === 'ejercicios' ? 'active' : ''}" onclick="changeTab('ejercicios')">
                            üèãÔ∏è Ejercicios
                        </button>
                        <button class="tab ${appState.currentTab === 'nutricion' ? 'active' : ''}" onclick="changeTab('nutricion')">
                            ü•ó Nutrici√≥n
                        </button>
                        <button class="tab ${appState.currentTab === 'lista' ? 'active' : ''}" onclick="changeTab('lista')">
                            üõí Lista Compra
                        </button>
                        <button class="tab ${appState.currentTab === 'chat' ? 'active' : ''}" onclick="changeTab('chat')">
                            üí¨ Chat IA
                        </button>
                        <button class="tab ${appState.currentTab === 'progreso' ? 'active' : ''}" onclick="changeTab('progreso')">
                            üìä Progreso
                        </button>
                        <button class="tab" onclick="showApiModal()">
                            ‚öôÔ∏è
                        </button>
                    </div>
                    
                    <div class="dashboard-content">
                        ${appState.currentTab === 'ejercicios' ? renderExercises() : ''}
                        ${appState.currentTab === 'nutricion' ? renderNutrition() : ''}
                        ${appState.currentTab === 'lista' ? renderShoppingList() : ''}
                        ${appState.currentTab === 'chat' ? renderChat() : ''}
                        ${appState.currentTab === 'progreso' ? renderProgress() : ''}
                    </div>
                    
                    ${appState.showApiModal ? renderApiModal() : ''}
                </div>
            `;
        }

        function renderApiModal() {
            const currentKey = localStorage.getItem('gemini_api_key') || '';
            const hasKey = currentKey.length > 0;
            
            return `
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px;" onclick="if(event.target === this) hideApiModal()">
                    <div style="background: white; border-radius: 15px; max-width: 500px; width: 100%; padding: 25px;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="font-size: 1.5rem; margin: 0;">‚öôÔ∏è Configurar API</h2>
                            <button onclick="hideApiModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px;">‚úï</button>
                        </div>
                        
                        ${hasKey ? `
                            <div style="background: #d1fae5; border: 1px solid #86efac; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                                <p style="color: #059669; font-weight: 600; margin-bottom: 5px;">‚úÖ API Key Configurada</p>
                                <p style="color: #047857; font-size: 0.9rem;">La IA est√° activa y funcionar√° con tu API key de Gemini.</p>
                            </div>
                        ` : `
                            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                                <p style="color: #d97706; font-weight: 600; margin-bottom: 5px;">‚ö†Ô∏è API Key No Configurada</p>
                                <p style="color: #92400e; font-size: 0.9rem;">Actualmente usando datos de ejemplo. Configura tu API key para planes reales generados por IA.</p>
                            </div>
                        `}
                        
                        <div style="background: #dbeafe; border: 1px solid #93c5fd; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                            <p style="font-weight: 600; margin-bottom: 10px; color: #1e40af;">üìñ ¬øC√≥mo obtener tu API key?</p>
                            <ol style="margin: 0; padding-left: 20px; font-size: 0.9rem; color: #1e3a8a; line-height: 1.8;">
                                <li>Ve a <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: #2563eb; text-decoration: underline;">Google AI Studio</a></li>
                                <li>Inicia sesi√≥n con tu cuenta de Google</li>
                                <li>Haz clic en "Create API Key"</li>
                                <li>Copia la clave y p√©gala aqu√≠ abajo</li>
                            </ol>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">API Key de Gemini:</label>
                            <input 
                                type="password" 
                                id="apiKeyInput" 
                                value="${currentKey}" 
                                placeholder="AIzaSy..." 
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: monospace;"
                            />
                            <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">Tu API key se guarda localmente en tu navegador y nunca se comparte.</p>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            ${hasKey ? `
                                <button onclick="removeApiKey()" style="flex: 1; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    üóëÔ∏è Eliminar
                                </button>
                            ` : ''}
                            <button onclick="hideApiModal()" style="flex: 1; padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Cancelar
                            </button>
                            <button onclick="saveApiKey()" style="flex: 2; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                üíæ Guardar
                            </button>
                        </div>
                        
                        ${hasKey ? `
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="regeneratePlans()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    üîÑ Regenerar Planes con IA
                                </button>
                                <p style="font-size: 0.8rem; color: #666; margin-top: 5px; text-align: center;">Esto crear√° nuevos planes personalizados usando Gemini</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function showApiModal() {
            appState.showApiModal = true;
            render();
        }

        function hideApiModal() {
            appState.showApiModal = false;
            render();
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            if (!input) return;
            
            const apiKey = input.value.trim();
            if (apiKey) {
                localStorage.setItem('gemini_api_key', apiKey);
                alert('‚úÖ API Key guardada correctamente. Ahora la IA generar√° planes reales.');
                hideApiModal();
            } else {
                alert('Por favor ingresa una API key v√°lida');
            }
        }

        function removeApiKey() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar tu API key?')) {
                localStorage.removeItem('gemini_api_key');
                alert('API Key eliminada. Volver√°s a usar planes de ejemplo.');
                hideApiModal();
            }
        }

        async function regeneratePlans() {
            if (confirm('¬øQuieres regenerar tus planes con la IA? Esto reemplazar√° tus planes actuales.')) {
                hideApiModal();
                await generatePlanWithAI();
            }
        }

        function renderExercises() {
            const plan = mockPlan.planEjercicios;
            
            // Check si hay workout en progreso
            const hasActiveWorkout = appState.currentWorkout !== null;
            
            // Bot√≥n para iniciar workout
            const todayWorkout = getTodayWorkout();
            
            if (appState.exerciseView === 'week') {
                return renderWeeklyExercises();
            }
            
            const selectedDay = plan.dias[appState.selectedDay];
            
            return `
                <div class="card">
                    <h2>Tu Plan de Ejercicios</h2>
                    <p style="color: #666; margin-bottom: 20px;">${plan.dias.length} d√≠as de entrenamiento</p>
                    
                    ${todayWorkout && !hasActiveWorkout ? `
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px;">üéØ Entrenamiento de Hoy</h3>
                            <p style="margin-bottom: 15px; opacity: 0.9;">${todayWorkout.dia} - ${todayWorkout.enfoque}</p>
                            <button onclick="startWorkout(${JSON.stringify(todayWorkout).replace(/"/g, '&quot;')})" 
                                    style="background: white; color: #059669; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%;">
                                ‚ñ∂Ô∏è Comenzar Entrenamiento
                            </button>
                        </div>
                    ` : ''}
                    
                    ${hasActiveWorkout ? `
                        <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="color: #d97706; margin: 0;">‚è±Ô∏è Entrenamiento en Progreso</h3>
                                <span style="background: #059669; color: white; padding: 5px 12px; border-radius: 12px; font-size: 0.85rem;">
                                    ${appState.currentWorkout.exercises.filter(e => e.completed).length}/${appState.currentWorkout.exercises.length} ejercicios
                                </span>
                            </div>
                            <p style="color: #92400e; margin-bottom: 15px;">${appState.currentWorkout.dayName} - ${appState.currentWorkout.planType}</p>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="finishWorkout()" style="flex: 1; background: #10b981; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    ‚úÖ Finalizar
                                </button>
                                <button onclick="if(confirm('¬øAbandonar entrenamiento?')) { appState.currentWorkout = null; localStorage.removeItem('current_workout'); render(); }" 
                                        style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                    ‚ùå
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="view-toggle">
                        <button class="view-btn ${appState.exerciseView === 'day' ? 'active' : ''}" 
                                onclick="toggleExerciseView('day')">
                            üìÖ Vista D√≠a
                        </button>
                        <button class="view-btn ${appState.exerciseView === 'week' ? 'active' : ''}" 
                                onclick="toggleExerciseView('week')">
                            üìÜ Vista Semanal
                        </button>
                    </div>
                    
                    <div class="day-selector">
                        ${plan.dias.map((dia, index) => `
                            <button class="day-btn ${appState.selectedDay === index ? 'active' : ''}" 
                                    onclick="selectDay(${index})">
                                ${dia.dia}
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <div class="card">
                    <h3>${selectedDay.dia}</h3>
                    <p style="color: #667eea; font-weight: 600; margin-bottom: 20px;">${selectedDay.enfoque}</p>
                    
                    ${selectedDay.ejercicios.map((ej, index) => {
                        const workoutEx = hasActiveWorkout ? appState.currentWorkout.exercises.find(e => e.name === ej.nombre) : null;
                        const isCompleted = workoutEx?.completed || false;
                        
                        return `
                        <div class="exercise-item ${isCompleted ? 'exercise-completed' : ''}" style="position: relative;">
                            ${hasActiveWorkout ? `
                                <input type="checkbox" 
                                       class="exercise-checkbox" 
                                       ${isCompleted ? 'checked' : ''}
                                       onchange="toggleExerciseComplete(${appState.currentWorkout.exercises.findIndex(e => e.name === ej.nombre)})"
                                       style="position: absolute; top: 15px; left: 15px;">
                            ` : ''}
                            
                            <div class="exercise-header" style="${hasActiveWorkout ? 'margin-left: 35px;' : ''}">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span class="exercise-number">#${index + 1}</span>
                                        <span class="exercise-name">${ej.nombre}</span>
                                    </div>
                                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">${ej.descripcion}</p>
                                    
                                    <div class="exercise-details">
                                        <div class="detail-item">
                                            <span class="detail-label">Series:</span>
                                            <span class="detail-value">${ej.series}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Reps:</span>
                                            <span class="detail-value">${ej.repeticiones}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Descanso:</span>
                                            <span class="detail-value">${ej.descanso}</span>
                                        </div>
                                    </div>
                                    
                                    ${hasActiveWorkout && workoutEx ? `
                                        <div class="set-logger">
                                            ${workoutEx.sets.map((set, setIndex) => `
                                                <div class="set-completed">
                                                    Set ${setIndex + 1}: ${set.peso}kg √ó ${set.reps}
                                                </div>
                                            `).join('')}
                                            
                                            ${workoutEx.sets.length < workoutEx.targetSets && !isCompleted ? `
                                                <input type="number" 
                                                       class="set-input" 
                                                       id="peso_${index}" 
                                                       placeholder="Peso (kg)"
                                                       step="2.5">
                                                <input type="number" 
                                                       class="set-input" 
                                                       id="reps_${index}" 
                                                       placeholder="Reps"
                                                       value="${ej.repeticiones.split('-')[0]}">
                                                <button class="btn-complete-set" 
                                                        onclick="const peso = document.getElementById('peso_${index}').value; const reps = document.getElementById('reps_${index}').value; if(peso && reps) { addSet(${appState.currentWorkout.exercises.findIndex(e => e.name === ej.nombre)}, peso, reps); }">
                                                    ‚úì Set ${workoutEx.sets.length + 1}
                                                </button>
                                            ` : ''}
                                        </div>
                                        
                                        ${workoutEx.volume ? `
                                            <div style="margin-top: 10px; padding: 8px; background: #f0fdf4; border-radius: 6px; font-size: 0.85rem; color: #059669;">
                                                üí™ Volumen: ${workoutEx.volume.toFixed(0)}kg
                                            </div>
                                        ` : ''}
                                    ` : ''}
                                </div>
                                
                                ${!hasActiveWorkout ? `
                                    <button class="speak-btn" onclick="speakExercise('${ej.nombre}', '${ej.series}', '${ej.repeticiones}', '${ej.descanso}', '${ej.descripcion}')" title="Escuchar">
                                        üé§
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `}).join('')}
                </div>
                
                ${appState.restTimer.active ? renderRestTimer() : ''}
            `;
        }

        function getTodayWorkout() {
            if (!appState.userPlan || !appState.userPlan.planEjercicios) return null;
            
            const today = new Date().toLocaleDateString('es-ES', { weekday: 'long' });
            const todayCapitalized = today.charAt(0).toUpperCase() + today.slice(1);
            
            const todayPlan = appState.userPlan.planEjercicios.semanaCompleta?.find(
                d => d.dia === todayCapitalized
            );
            
            if (todayPlan && todayPlan.tipo === 'entrenamiento') {
                return todayPlan;
            }
            
            return null;
        }

        function renderRestTimer() {
            const mins = Math.floor(appState.restTimer.timeLeft / 60);
            const secs = appState.restTimer.timeLeft % 60;
            const progress = (appState.restTimer.timeLeft / appState.restTimer.totalTime) * 100;
            
            return `
                <div class="timer-overlay" onclick="stopRestTimer()"></div>
                <div class="timer-modal">
                    <h2 style="margin-bottom: 10px;">‚è±Ô∏è Descanso</h2>
                    <div class="timer-display" id="timer-display">
                        ${mins}:${secs.toString().padStart(2, '0')}
                    </div>
                    <div class="timer-progress">
                        <div class="timer-progress-bar" id="timer-progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="timer-buttons">
                        <button class="timer-btn timer-btn-pause" onclick="event.stopPropagation(); pauseRestTimer()">
                            ${appState.restTimer.isPaused ? '‚ñ∂Ô∏è Reanudar' : '‚è∏Ô∏è Pausar'}
                        </button>
                        <button class="timer-btn timer-btn-stop" onclick="event.stopPropagation(); stopRestTimer()">
                            ‚è≠Ô∏è Saltar
                        </button>
                    </div>
                </div>
            `;
        }

        function renderWeeklyExercises() {
            const plan = mockPlan.planEjercicios.semanaCompleta;
            const diasEntrenamiento = plan.filter(d => d.tipo === 'entrenamiento').length;
            const totalEjercicios = plan.reduce((sum, d) => sum + (d.ejercicios?.length || 0), 0);
            const selectedDay = plan[appState.selectedWeekDay];
            
            return `
                <div class="card">
                    <h2>Tu Plan de Ejercicios</h2>
                    
                    <div class="view-toggle">
                        <button class="view-btn ${appState.exerciseView === 'day' ? 'active' : ''}" 
                                onclick="toggleExerciseView('day')">
                            üìÖ Vista D√≠a
                        </button>
                        <button class="view-btn ${appState.exerciseView === 'week' ? 'active' : ''}" 
                                onclick="toggleExerciseView('week')">
                            üìÜ Vista Semanal
                        </button>
                    </div>

                    <div class="weekly-overview">
                        <h3 style="margin-bottom: 10px;">Resumen Semanal</h3>
                        <div class="weekly-stats">
                            <div class="weekly-stat">
                                <div class="weekly-stat-value">${diasEntrenamiento}</div>
                                <div class="weekly-stat-label">D√≠as Activos</div>
                            </div>
                            <div class="weekly-stat">
                                <div class="weekly-stat-value">${totalEjercicios}</div>
                                <div class="weekly-stat-label">Ejercicios Total</div>
                            </div>
                            <div class="weekly-stat">
                                <div class="weekly-stat-value">${7 - diasEntrenamiento}</div>
                                <div class="weekly-stat-label">D√≠as Descanso</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="weekly-grid">
                        ${plan.map((dia, index) => `
                            <div class="day-cell ${appState.selectedWeekDay === index ? 'active' : ''} ${dia.tipo === 'descanso' ? 'rest' : ''}" 
                                 onclick="selectWeekDay(${index})">
                                <div class="day-name">${dia.dia.slice(0, 3)}</div>
                                <div class="day-icon">${dia.tipo === 'entrenamiento' ? 'üí™' : 'üò¥'}</div>
                                <div class="day-label">${dia.tipo === 'entrenamiento' ? dia.ejercicios.length + ' ej' : 'Rest'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="card">
                    <h3>${selectedDay.dia}</h3>
                    ${selectedDay.tipo === 'entrenamiento' ? `
                        <p style="color: #667eea; font-weight: 600; margin-bottom: 20px;">${selectedDay.enfoque}</p>
                        ${selectedDay.ejercicios.map((ej, index) => `
                            <div class="exercise-item">
                                <div class="exercise-header">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                            <span class="exercise-number">#${index + 1}</span>
                                            <span class="exercise-name">${ej.nombre}</span>
                                        </div>
                                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">${ej.descripcion}</p>
                                        <div class="exercise-details">
                                            <div class="detail-item">
                                                <span class="detail-label">Series:</span>
                                                <span class="detail-value">${ej.series}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Reps:</span>
                                                <span class="detail-value">${ej.repeticiones}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Descanso:</span>
                                                <span class="detail-value">${ej.descanso}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="speak-btn" onclick="speakExercise('${ej.nombre}', '${ej.series}', '${ej.repeticiones}', '${ej.descanso}', '${ej.descripcion}')" title="Escuchar">
                                        üé§
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    ` : `
                        <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">üò¥</div>
                            <h4 style="color: #059669; margin-bottom: 10px;">D√≠a de Descanso</h4>
                            <p style="color: #047857;">${selectedDay.descripcion}</p>
                        </div>
                    `}
                </div>
            `;
        }

        function renderNutrition() {
            const plan = mockPlan.planNutricion;
            
            if (appState.nutritionView === 'week') {
                return renderWeeklyNutrition();
            }
            
            return `
                <div class="card">
                    <h2>Tu Plan de Nutrici√≥n</h2>
                    
                    <div class="view-toggle">
                        <button class="view-btn ${appState.nutritionView === 'day' ? 'active' : ''}" 
                                onclick="toggleNutritionView('day')">
                            üìÖ Vista D√≠a
                        </button>
                        <button class="view-btn ${appState.nutritionView === 'week' ? 'active' : ''}" 
                                onclick="toggleNutritionView('week')">
                            üìÜ Vista Semanal
                        </button>
                    </div>
                    
                    <div class="macro-grid">
                        <div class="macro-card calories">
                            <div class="macro-label">Calor√≠as</div>
                            <div class="macro-value">${plan.calorias}</div>
                            <div class="macro-label">kcal/d√≠a</div>
                        </div>
                        <div class="macro-card protein">
                            <div class="macro-label">Prote√≠nas</div>
                            <div class="macro-value">${plan.proteinas}g</div>
                            <div class="macro-label">por d√≠a</div>
                        </div>
                        <div class="macro-card carbs">
                            <div class="macro-label">Carbohidratos</div>
                            <div class="macro-value">${plan.carbohidratos}g</div>
                            <div class="macro-label">por d√≠a</div>
                        </div>
                        <div class="macro-card fat">
                            <div class="macro-label">Grasas</div>
                            <div class="macro-value">${plan.grasas}g</div>
                            <div class="macro-label">por d√≠a</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Plan Diario de Comidas</h3>
                    ${plan.comidas.map(comida => {
                        const totalCal = comida.alimentos.reduce((sum, a) => sum + a.calorias, 0);
                        return `
                            <div class="meal-item">
                                <div class="meal-header">
                                    <div>
                                        <div class="meal-name">${comida.momento}</div>
                                        <div class="meal-time">‚è∞ ${comida.hora}</div>
                                    </div>
                                    <div class="meal-calories">${totalCal} kcal</div>
                                </div>
                                <div class="food-list">
                                    ${comida.alimentos.map(alimento => `
                                        <div class="food-item">
                                            <div>
                                                <span class="food-name">${alimento.nombre}</span>
                                                <span class="food-amount">(${alimento.cantidad})</span>
                                                <span class="food-store">${alimento.tienda}</span>
                                            </div>
                                            <div style="color: #666;">${alimento.calorias} kcal</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderWeeklyNutrition() {
            const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            const plan = mockPlan.planNutricion;
            const caloriasSemanales = plan.calorias * 7;
            
            return `
                <div class="card">
                    <h2>Tu Plan de Nutrici√≥n</h2>
                    
                    <div class="view-toggle">
                        <button class="view-btn ${appState.nutritionView === 'day' ? 'active' : ''}" 
                                onclick="toggleNutritionView('day')">
                            üìÖ Vista D√≠a
                        </button>
                        <button class="view-btn ${appState.nutritionView === 'week' ? 'active' : ''}" 
                                onclick="toggleNutritionView('week')">
                            üìÜ Vista Semanal
                        </button>
                    </div>

                    <div class="weekly-overview">
                        <h3 style="margin-bottom: 10px;">Resumen Semanal</h3>
                        <div class="weekly-stats">
                            <div class="weekly-stat">
                                <div class="weekly-stat-value">${caloriasSemanales}</div>
                                <div class="weekly-stat-label">Calor√≠as/Semana</div>
                            </div>
                            <div class="weekly-stat">
                                <div class="weekly-stat-value">${plan.proteinas * 7}g</div>
                                <div class="weekly-stat-label">Prote√≠na/Semana</div>
                            </div>
                            <div class="weekly-stat">
                                <div class="weekly-stat-value">${plan.comidas.length}</div>
                                <div class="weekly-stat-label">Comidas/D√≠a</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Plan de la Semana</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">
                        Cada d√≠a sigue el mismo patr√≥n nutricional adaptado a tus objetivos
                    </p>
                    
                    <div class="nutrition-week-grid">
                        ${diasSemana.map((dia, index) => `
                            <div class="day-nutrition-card ${appState.selectedWeekDay === index ? 'active' : ''}" 
                                 onclick="selectWeekDay(${index})">
                                <div class="day-nutrition-header">
                                    <div class="day-nutrition-name">${dia}</div>
                                    <div class="day-nutrition-cals">${plan.calorias} kcal</div>
                                </div>
                                
                                <div class="mini-macro-grid">
                                    <div class="mini-macro protein">
                                        <div style="font-size: 0.7rem; margin-bottom: 3px;">Prote√≠na</div>
                                        <div class="mini-macro-value">${plan.proteinas}g</div>
                                    </div>
                                    <div class="mini-macro carbs">
                                        <div style="font-size: 0.7rem; margin-bottom: 3px;">Carbos</div>
                                        <div class="mini-macro-value">${plan.carbohidratos}g</div>
                                    </div>
                                    <div class="mini-macro fat">
                                        <div style="font-size: 0.7rem; margin-bottom: 3px;">Grasas</div>
                                        <div class="mini-macro-value">${plan.grasas}g</div>
                                    </div>
                                </div>
                                
                                <div class="meal-summary">
                                    ${plan.comidas.map(c => `
                                        <span class="meal-tag">${c.momento}</span>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card">
                    <h3>Detalle: ${diasSemana[appState.selectedWeekDay]}</h3>
                    ${plan.comidas.map(comida => {
                        const totalCal = comida.alimentos.reduce((sum, a) => sum + a.calorias, 0);
                        return `
                            <div class="meal-item">
                                <div class="meal-header">
                                    <div>
                                        <div class="meal-name">${comida.momento}</div>
                                        <div class="meal-time">‚è∞ ${comida.hora}</div>
                                    </div>
                                    <div class="meal-calories">${totalCal} kcal</div>
                                </div>
                                <div class="food-list">
                                    ${comida.alimentos.map(alimento => `
                                        <div class="food-item">
                                            <div>
                                                <span class="food-name">${alimento.nombre}</span>
                                                <span class="food-amount">(${alimento.cantidad})</span>
                                                <span class="food-store">${alimento.tienda}</span>
                                            </div>
                                            <div style="color: #666;">${alimento.calorias} kcal</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderShoppingList() {
            const list = mockPlan.planNutricion.listaCompra;
            let total = 0;
            
            Object.values(list).forEach(category => {
                category.forEach(item => {
                    total += parseFloat(item.precio.replace('‚Ç¨', ''));
                });
            });
            
            return `
                <div class="total-price">
                    <div class="label">Total Estimado Semanal</div>
                    <div class="amount">${total.toFixed(2)}‚Ç¨</div>
                </div>
                
                ${Object.entries(list).map(([category, items]) => `
                    <div class="card shopping-category">
                        <div class="category-title">
                            ${category === 'Prote√≠nas' ? 'üçó' : ''}
                            ${category === 'Carbohidratos' ? 'üçö' : ''}
                            ${category === 'Frutas y Verduras' ? 'ü•¨' : ''}
                            ${category === 'L√°cteos' ? 'ü•õ' : ''}
                            ${category}
                        </div>
                        ${items.map((item, index) => `
                            <div class="shopping-item" onclick="toggleShoppingItem(this)">
                                <input type="checkbox" onclick="event.stopPropagation();">
                                <div class="item-info">
                                    <div class="item-name">${item.item}</div>
                                    <div class="item-store">${item.tienda}</div>
                                </div>
                                <div class="item-price">${item.precio}</div>
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
            `;
        }

        function renderChat() {
            if (appState.chatMessages.length === 0) {
                appState.chatMessages = [{
                    role: 'assistant',
                    content: `¬°Hola ${appState.userData.nombre || ''}! üëã Soy tu entrenador personal virtual. Puedo ayudarte con:\n\n‚Ä¢ Dudas sobre ejercicios\n‚Ä¢ Modificar tu rutina\n‚Ä¢ Cambiar alimentos\n‚Ä¢ Consejos de nutrici√≥n\n‚Ä¢ T√©cnica y forma\n\n¬øEn qu√© puedo ayudarte?`
                }];
            }
            
            const hasApiKey = localStorage.getItem('gemini_api_key');
            
            return `
                <div class="card">
                    <h2>üí¨ Chat con tu Entrenador IA</h2>
                    ${!hasApiKey ? `
                        <div class="alert">
                            ‚ö†Ô∏è <strong>Modo Demo:</strong> Respuestas simuladas. 
                            <button onclick="showApiModal()" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 6px; margin-left: 10px; cursor: pointer; font-size: 0.9rem;">
                                Activar IA Real
                            </button>
                        </div>
                    ` : `
                        <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem;">
                            ‚úÖ <strong>IA Activa:</strong> Respuestas generadas por Gemini con tu contexto personal.
                        </div>
                    `}
                    
                    <div class="chat-container" id="chatContainer" role="log" aria-live="polite" aria-atomic="false">
                        ${appState.chatMessages.map(msg => `
                            <div class="chat-message ${msg.role}">
                                <div class="message-bubble">${msg.content.replace(/\n/g, '<br>')}</div>
                            </div>
                        `).join('')}
                        ${appState.isLoading ? `
                            <div class="chat-message assistant">
                                <div class="chat-loading">
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="quick-questions">
                        <button class="quick-btn" onclick="setMessage('¬øC√≥mo hacer sentadillas correctamente?')">
                            ¬øSentadillas correctamente?
                        </button>
                        <button class="quick-btn" onclick="setMessage('Cambiar el pollo por otra prote√≠na')">
                            Cambiar pollo
                        </button>
                        <button class="quick-btn" onclick="setMessage('Dame consejos de motivaci√≥n')">
                            Motivaci√≥n
                        </button>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Escribe tu pregunta..." 
                               onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="send-btn" onclick="sendMessage()" ${appState.isLoading ? 'disabled' : ''}>
                            Enviar
                        </button>
                    </div>
                </div>
            `;
        }

        function renderProgress() {
            const imc = appState.userData.peso && appState.userData.altura 
                ? (appState.userData.peso / Math.pow(appState.userData.altura / 100, 2)).toFixed(1)
                : '-';
            
            // Cargar historial si no est√° cargado
            if (!appState.progresoHistorial || appState.progresoHistorial.length === 0) {
                loadProgressHistory();
            }
            
            // Check recordatorios
            const reminder = checkReminders();
            
            const ultimaMedicion = appState.progresoHistorial.length > 0 
                ? appState.progresoHistorial[appState.progresoHistorial.length - 1]
                : null;
            
            return `
                ${reminder.show ? `
                    <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 20px; margin-bottom: 20px; animation: pulse 2s infinite;">
                        <h3 style="color: #d97706; margin-bottom: 10px;">‚è∞ ¬°Es hora de actualizar tu progreso!</h3>
                        <p style="color: #92400e; margin-bottom: 15px;">${reminder.message}. Actualiza tus medidas y foto para que la IA analice tu progreso y ajuste tu plan.</p>
                        <button onclick="scrollToUpdateSection()" style="background: #f59e0b; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%;">
                            üì∏ Actualizar Ahora
                        </button>
                    </div>
                ` : ''}
                
                ${appState.notificacionProgreso ? `
                    <div style="background: #d1fae5; border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative;">
                        <button onclick="appState.notificacionProgreso = null; render();" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                        <h3 style="color: #059669; margin-bottom: 10px;">üéØ An√°lisis de tu Progreso</h3>
                        <p style="color: #047857; margin-bottom: 15px; font-weight: 500;">${appState.notificacionProgreso.analisis}</p>
                        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="font-size: 0.9rem; color: #059669; margin-bottom: 10px;">üìã Recomendaciones:</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #047857;">
                                ${appState.notificacionProgreso.recomendaciones.map(rec => `<li style="margin-bottom: 5px;">${rec}</li>`).join('')}
                            </ul>
                        </div>
                        <p style="color: #059669; font-weight: 600; font-style: italic;">üí¨ ${appState.notificacionProgreso.motivacion}</p>
                    </div>
                ` : ''}
                
                <div class="card">
                    <h2>Tu Progreso</h2>
                    <p style="color: #666; margin-bottom: 20px;">Registra tus mediciones y observa tu evoluci√≥n üìä</p>
                    
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-label">Peso Actual</div>
                            <div class="stat-value">${ultimaMedicion?.peso || appState.userData.peso || '-'}</div>
                            <div class="stat-unit">kg</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);">
                            <div class="stat-label">IMC</div>
                            <div class="stat-value">${imc}</div>
                            <div class="stat-unit">kg/m¬≤</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <div class="stat-label">Actualizaciones</div>
                            <div class="stat-value">${appState.progresoHistorial.length}</div>
                            <div class="stat-unit">registros</div>
                        </div>
                    </div>
                    
                    ${appState.progresoHistorial.length > 1 ? `
                        <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 10px; padding: 15px; margin-top: 20px;">
                            <h4 style="color: #059669; margin-bottom: 10px;">üìà Tu Evoluci√≥n</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div>
                                    <p style="font-size: 0.85rem; color: #047857; margin-bottom: 3px;">Peso inicial</p>
                                    <p style="font-size: 1.2rem; font-weight: bold; color: #059669;">${appState.progresoHistorial[0].peso}kg</p>
                                </div>
                                <div>
                                    <p style="font-size: 0.85rem; color: #047857; margin-bottom: 3px;">Cambio total</p>
                                    <p style="font-size: 1.2rem; font-weight: bold; color: ${(parseFloat(ultimaMedicion.peso) - parseFloat(appState.progresoHistorial[0].peso)) < 0 ? '#059669' : '#dc2626'};">
                                        ${(parseFloat(ultimaMedicion.peso) - parseFloat(appState.progresoHistorial[0].peso)) > 0 ? '+' : ''}${(parseFloat(ultimaMedicion.peso) - parseFloat(appState.progresoHistorial[0].peso)).toFixed(1)}kg
                                    </p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="card" id="updateSection">
                    <h3>üì∏ Registrar Nueva Medici√≥n</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">
                        Actualiza cada 2 semanas para que la IA analice tu progreso y optimice tu plan
                    </p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Peso (kg)</label>
                            <input type="number" id="nuevo_peso" placeholder="${ultimaMedicion?.peso || appState.userData.peso || '70'}" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Cintura (cm)</label>
                            <input type="number" id="nuevo_cintura" placeholder="${ultimaMedicion?.medidas?.cintura || '80'}" step="0.1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pecho (cm)</label>
                            <input type="number" id="nuevo_pecho" placeholder="${ultimaMedicion?.medidas?.pecho || '90'}" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Cadera (cm)</label>
                            <input type="number" id="nuevo_cadera" placeholder="${ultimaMedicion?.medidas?.cadera || '95'}" step="0.1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Brazo (cm)</label>
                        <input type="number" id="nuevo_brazo" placeholder="${ultimaMedicion?.medidas?.brazo || '30'}" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label>Foto de progreso</label>
                        <input type="file" id="nueva_foto" accept="image/*" capture="environment" 
                               style="width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; background: #f9f9f9;">
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                            üì∑ Toma la foto en las mismas condiciones que la inicial para mejor comparaci√≥n
                        </p>
                    </div>
                    
                    <button class="btn-next" style="margin-top: 15px;" onclick="guardarNuevaMedicion()">
                        üíæ Guardar y Analizar con IA
                    </button>
                </div>
                
                ${appState.progresoHistorial.length > 0 ? `
                    <div class="card">
                        <h3>üìú Historial de Mediciones</h3>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${appState.progresoHistorial.slice().reverse().map((medicion, index) => {
                                const fecha = new Date(medicion.fecha);
                                const fechaFormateada = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                                
                                return `
                                    <div style="border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; ${medicion.tipo === 'inicial' ? 'background: #f0e7ff;' : ''}">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <div>
                                                <p style="font-weight: 600; margin-bottom: 3px;">${fechaFormateada}</p>
                                                <p style="font-size: 0.85rem; color: #666;">
                                                    ${medicion.tipo === 'inicial' ? 'üèÅ Medici√≥n Inicial' : 'üìä Seguimiento #' + (appState.progresoHistorial.length - index)}
                                                </p>
                                            </div>
                                            <div style="text-align: right;">
                                                <p style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${medicion.peso}kg</p>
                                            </div>
                                        </div>
                                        
                                        ${medicion.medidas && (medicion.medidas.pecho || medicion.medidas.cintura || medicion.medidas.cadera) ? `
                                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.85rem; margin-top: 10px;">
                                                ${medicion.medidas.pecho ? `<div>Pecho: <strong>${medicion.medidas.pecho}cm</strong></div>` : ''}
                                                ${medicion.medidas.cintura ? `<div>Cintura: <strong>${medicion.medidas.cintura}cm</strong></div>` : ''}
                                                ${medicion.medidas.cadera ? `<div>Cadera: <strong>${medicion.medidas.cadera}cm</strong></div>` : ''}
                                                ${medicion.medidas.brazo ? `<div>Brazo: <strong>${medicion.medidas.brazo}cm</strong></div>` : ''}
                                            </div>
                                        ` : ''}
                                        
                                        ${medicion.foto ? `
                                            <div style="margin-top: 10px;">
                                                <img src="${medicion.foto}" alt="Foto de progreso" style="width: 100%; max-width: 200px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                            </div>
                                        ` : ''}
                                        
                                        ${medicion.analisisIA ? `
                                            <div style="background: #d1fae5; border-radius: 8px; padding: 10px; margin-top: 10px;">
                                                <p style="font-size: 0.85rem; color: #059669; font-weight: 600; margin-bottom: 5px;">ü§ñ An√°lisis IA:</p>
                                                <p style="font-size: 0.8rem; color: #047857;">${medicion.analisisIA.analisis}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function scrollToUpdateSection() {
            const section = document.getElementById('updateSection');
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function guardarNuevaMedicion() {
            const peso = document.getElementById('nuevo_peso')?.value;
            const pecho = document.getElementById('nuevo_pecho')?.value;
            const cintura = document.getElementById('nuevo_cintura')?.value;
            const cadera = document.getElementById('nuevo_cadera')?.value;
            const brazo = document.getElementById('nuevo_brazo')?.value;
            const fotoInput = document.getElementById('nueva_foto');
            
            if (!peso) {
                alert('‚ùå Por favor ingresa al menos tu peso actual');
                return;
            }
            
            const medidas = {
                pecho: pecho || '',
                cintura: cintura || '',
                cadera: cadera || '',
                brazo: brazo || ''
            };
            
            if (fotoInput && fotoInput.files && fotoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveProgressUpdate(peso, medidas, e.target.result);
                    alert('‚úÖ Medici√≥n guardada. La IA est√° analizando tu progreso...');
                    render();
                };
                reader.readAsDataURL(fotoInput.files[0]);
            } else {
                saveProgressUpdate(peso, medidas, null);
                alert('‚úÖ Medici√≥n guardada. La IA est√° analizando tu progreso...');
                render();
            }
        }

        // Event listeners y funciones globales
        function attachEventListeners() {
            // Los event listeners inline (onclick) ya est√°n definidos
        }

        function startApp() {
            appState.currentScreen = 'form';
            render();
        }

        function nextPage() {
            // Validar campos obligatorios antes de avanzar
            if (appState.currentFormPage === 1) {
                const nombre = document.getElementById('nombre')?.value || '';
                const edad = document.getElementById('edad')?.value || '';
                const genero = document.getElementById('genero')?.value || '';
                const peso = document.getElementById('peso')?.value || '';
                const altura = document.getElementById('altura')?.value || '';
                
                if (!nombre.trim()) {
                    showFormError('‚ùå Por favor ingresa tu nombre');
                    return;
                }
                if (!edad || edad < 15 || edad > 100) {
                    showFormError('‚ùå Por favor ingresa una edad v√°lida (15-100 a√±os)');
                    return;
                }
                if (!genero) {
                    showFormError('‚ùå Por favor selecciona tu g√©nero');
                    return;
                }
                if (!peso || peso < 30 || peso > 300) {
                    showFormError('‚ùå Por favor ingresa un peso v√°lido (30-300 kg)');
                    return;
                }
                if (!altura || altura < 100 || altura > 250) {
                    showFormError('‚ùå Por favor ingresa una altura v√°lida (100-250 cm)');
                    return;
                }
                
                // Guardar datos si pasan validaci√≥n
                appState.userData.nombre = nombre;
                appState.userData.edad = edad;
                appState.userData.genero = genero;
                appState.userData.peso = peso;
                appState.userData.altura = altura;
                appState.userData.lesiones = document.getElementById('lesiones')?.value || '';
                
                // Guardar medidas opcionales
                appState.userData.medidas = {
                    pecho: document.getElementById('medida_pecho')?.value || '',
                    cintura: document.getElementById('medida_cintura')?.value || '',
                    cadera: document.getElementById('medida_cadera')?.value || '',
                    brazo: document.getElementById('medida_brazo')?.value || ''
                };
                
                // Guardar foto inicial si existe
                const fotoInput = document.getElementById('foto_inicial');
                if (fotoInput && fotoInput.files && fotoInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        appState.userData.fotoInicial = e.target.result;
                        // Guardar tambi√©n en historial de progreso
                        if (!appState.progresoHistorial) {
                            appState.progresoHistorial = [];
                        }
                        appState.progresoHistorial.push({
                            fecha: new Date().toISOString(),
                            peso: peso,
                            foto: e.target.result,
                            medidas: appState.userData.medidas,
                            tipo: 'inicial'
                        });
                        localStorage.setItem('progreso_historial', JSON.stringify(appState.progresoHistorial));
                    };
                    reader.readAsDataURL(fotoInput.files[0]);
                }
                
            } else if (appState.currentFormPage === 2) {
                const objetivo = document.getElementById('objetivo')?.value || '';
                const nivelActividad = document.getElementById('nivelActividad')?.value || '';
                const lugarEntrenamiento = document.getElementById('lugarEntrenamiento')?.value || '';
                const diasSemana = document.getElementById('diasSemana')?.value || '';
                
                if (!objetivo) {
                    showFormError('‚ùå Por favor selecciona tu objetivo principal');
                    return;
                }
                if (!nivelActividad) {
                    showFormError('‚ùå Por favor selecciona tu nivel de actividad');
                    return;
                }
                if (!lugarEntrenamiento) {
                    showFormError('‚ùå Por favor selecciona d√≥nde prefieres entrenar');
                    return;
                }
                if (!diasSemana) {
                    showFormError('‚ùå Por favor selecciona cu√°ntos d√≠as puedes entrenar');
                    return;
                }
                
                // Guardar datos si pasan validaci√≥n
                appState.userData.objetivo = objetivo;
                appState.userData.nivelActividad = nivelActividad;
                appState.userData.lugarEntrenamiento = lugarEntrenamiento;
                appState.userData.diasSemana = diasSemana;
                
                // Guardar equipo disponible
                const equipoItems = [
                    'mancuernas', 'barra', 'kettlebell', 'bandas', 'trx', 'banco', 'rack', 
                    'barra_dominadas', 'cinta', 'bici', 'eliptica', 'remo', 'colchoneta', 
                    'step', 'balon', 'cuerda', 'nada', 'exterior'
                ];
                appState.userData.equipoDisponible = equipoItems.filter(item => 
                    document.getElementById(`equipo_${item}`)?.checked
                );
            }
            
            appState.currentFormPage++;
            render();
        }

        function prevPage() {
            appState.currentFormPage--;
            render();
        }

        function submitForm() {
            // Guardar datos finales
            appState.userData.restricciones = document.getElementById('restricciones')?.value || 'ninguna';
            appState.userData.presupuesto = document.getElementById('presupuesto')?.value || '';
            
            // Validar que el presupuesto est√© seleccionado
            if (!appState.userData.presupuesto) {
                alert('‚ùå Por favor selecciona tu presupuesto semanal aproximado');
                return;
            }
            
            // Generar plan con IA
            generatePlanWithAI();
        }

        async function generatePlanWithAI() {
            const apiKey = localStorage.getItem('gemini_api_key');
            
            if (!apiKey) {
                // Si no hay API key, usar plan simulado
                console.log('No API key found, using mock data');
                appState.userPlan = mockPlan;
                appState.currentScreen = 'dashboard';
                render();
                return;
            }

            // Mostrar loading
            document.getElementById('app').innerHTML = `
                <div style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ü§ñ</div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 10px;">Generando tu plan personalizado...</h2>
                    <p style="color: #666; margin-bottom: 30px;">La IA est√° analizando tus datos y creando el mejor plan para ti</p>
                    <div style="width: 200px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                        <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); animation: loading 2s infinite;"></div>
                    </div>
                    <style>
                        @keyframes loading {
                            0% { transform: translateX(-100%); }
                            100% { transform: translateX(100%); }
                        }
                    </style>
                </div>
            `;

            try {
                // Generar plan de ejercicios
                const exercisePlan = await generateExercisePlan(apiKey);
                
                // Generar plan de nutrici√≥n
                const nutritionPlan = await generateNutritionPlan(apiKey);
                
                // Combinar planes
                appState.userPlan = {
                    planEjercicios: exercisePlan,
                    planNutricion: nutritionPlan
                };
                
                // Guardar en localStorage para persistencia
                localStorage.setItem('user_plan', JSON.stringify(appState.userPlan));
                localStorage.setItem('user_data', JSON.stringify(appState.userData));
                
                appState.currentScreen = 'dashboard';
                render();
                
            } catch (error) {
                console.error('Error generating plan:', error);
                alert('Error al generar el plan. Usando plan de ejemplo. Verifica tu API key en Configuraci√≥n.');
                appState.userPlan = mockPlan;
                appState.currentScreen = 'dashboard';
                render();
            }
        }

        async function generateExercisePlan(apiKey) {
            const userData = appState.userData;
            const equipoTexto = (userData.equipoDisponible || []).join(', ') || 'ninguno';
            
            const prompt = `Eres un entrenador personal profesional. Crea un plan de ejercicios detallado y personalizado en formato JSON.

DATOS DEL USUARIO:
- Nombre: ${userData.nombre}
- Edad: ${userData.edad} a√±os
- G√©nero: ${userData.genero}
- Peso: ${userData.peso}kg
- Altura: ${userData.altura}cm
- Objetivo: ${userData.objetivo}
- Nivel de actividad: ${userData.nivelActividad}
- Lugar de entrenamiento: ${userData.lugarEntrenamiento}
- D√≠as por semana: ${userData.diasSemana}
- Equipo disponible: ${equipoTexto}
- Experiencia: ${userData.experienciaGym || 'no especificada'}
- Lesiones: ${userData.lesiones || 'ninguna'}

INSTRUCCIONES:
1. Crea un plan COMPLETO de 7 d√≠as (toda la semana)
2. Incluye d√≠as de descanso estrat√©gicos
3. Adapta TODOS los ejercicios al equipo disponible
4. Si no tiene equipo, usa solo peso corporal
5. Respeta las lesiones mencionadas
6. Ajusta la intensidad al nivel de experiencia

FORMATO DE RESPUESTA (JSON estricto, sin markdown, sin comentarios):
{
  "semanaCompleta": [
    {
      "dia": "Lunes",
      "tipo": "entrenamiento",
      "enfoque": "Tren Superior",
      "ejercicios": [
        {
          "nombre": "Press de pecho con mancuernas",
          "series": 4,
          "repeticiones": "8-12",
          "descanso": "90s",
          "descripcion": "Acu√©state en banco plano, baja mancuernas hasta pecho y empuja hacia arriba"
        }
      ]
    },
    {
      "dia": "Martes",
      "tipo": "descanso",
      "descripcion": "D√≠a de descanso activo. Camina 20-30 minutos o haz estiramientos suaves."
    }
  ],
  "dias": [
    {
      "dia": "Lunes",
      "enfoque": "Tren Superior",
      "ejercicios": [...]
    }
  ]
}

IMPORTANTE: 
- "semanaCompleta" debe tener los 7 d√≠as (Lunes a Domingo)
- "dias" solo debe tener los d√≠as de entrenamiento
- Cada d√≠a de entrenamiento debe tener 4-6 ejercicios
- D√≠as de descanso solo necesitan "dia", "tipo" y "descripcion"
- NO uses ejercicios que requieran equipo que el usuario no tiene`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 4096
                    }
                })
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error?.message || 'Error en la API');
            }

            let textResponse = data.candidates[0].content.parts[0].text;
            
            // Limpiar respuesta de markdown
            textResponse = textResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            const plan = JSON.parse(textResponse);
            return plan;
        }

        async function generateNutritionPlan(apiKey) {
            const userData = appState.userData;
            const restriccionesTexto = (userData.restriccionesAlimentarias || []).join(', ') || 'ninguna';
            
            // Calcular TMB (Tasa Metab√≥lica Basal) y calor√≠as necesarias
            const peso = parseFloat(userData.peso);
            const altura = parseFloat(userData.altura);
            const edad = parseFloat(userData.edad);
            
            let tmb;
            if (userData.genero === 'masculino') {
                tmb = 10 * peso + 6.25 * altura - 5 * edad + 5;
            } else {
                tmb = 10 * peso + 6.25 * altura - 5 * edad - 161;
            }
            
            const multiplicadores = {
                'sedentario': 1.2,
                'ligero': 1.375,
                'moderado': 1.55,
                'muy_activo': 1.725,
                'atleta': 1.9
            };
            
            const factorActividad = multiplicadores[userData.nivelActividad] || 1.375;
            let caloriasMeta = Math.round(tmb * factorActividad);
            
            // Ajustar seg√∫n objetivo
            if (userData.objetivo === 'perder_peso') {
                caloriasMeta -= 500;
            } else if (userData.objetivo === 'ganar_musculo') {
                caloriasMeta += 300;
            }

            const prompt = `Eres un nutricionista profesional. Crea un plan de nutrici√≥n detallado y personalizado en formato JSON.

DATOS DEL USUARIO:
- Peso: ${userData.peso}kg
- Altura: ${userData.altura}cm
- Edad: ${userData.edad} a√±os
- G√©nero: ${userData.genero}
- Objetivo: ${userData.objetivo}
- Nivel de actividad: ${userData.nivelActividad}
- Calor√≠as objetivo calculadas: ${caloriasMeta} kcal/d√≠a
- Restricciones: ${restriccionesTexto}
- Presupuesto: ${userData.presupuesto || 'medio'}

INSTRUCCIONES:
1. Crea un plan con exactamente ${caloriasMeta} calor√≠as diarias
2. SOLO usa productos disponibles en: Mercadona, Aldi, Eroski
3. Respeta TODAS las restricciones alimentarias
4. Incluye 5 comidas: Desayuno, Media Ma√±ana, Comida, Merienda, Cena
5. Calcula macros: Prote√≠na 25-30%, Carbohidratos 40-50%, Grasas 20-30%
6. S√© espec√≠fico con marcas espa√±olas (Hacendado, etc.)
7. Crea una lista de compra semanal organizada

FORMATO DE RESPUESTA (JSON estricto, sin markdown):
{
  "calorias": ${caloriasMeta},
  "proteinas": 150,
  "carbohidratos": 200,
  "grasas": 65,
  "comidas": [
    {
      "momento": "Desayuno",
      "hora": "8:00",
      "alimentos": [
        {
          "nombre": "Avena Hacendado",
          "cantidad": "80g",
          "tienda": "Mercadona",
          "calorias": 304
        }
      ]
    }
  ],
  "listaCompra": {
    "Prote√≠nas": [
      {
        "item": "Pechuga de pollo (1.4kg)",
        "tienda": "Mercadona",
        "precio": "8.40‚Ç¨"
      }
    ],
    "Carbohidratos": [],
    "Frutas y Verduras": [],
    "L√°cteos": [],
    "Otros": []
  }
}

IMPORTANTE:
- Las calor√≠as totales de todas las comidas deben sumar aproximadamente ${caloriasMeta}
- Todos los productos deben ser reales y disponibles en Espa√±a
- La lista de compra debe ser para 7 d√≠as
- Incluye precios estimados realistas`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 4096
                    }
                })
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error?.message || 'Error en la API');
            }

            let textResponse = data.candidates[0].content.parts[0].text;
            
            // Limpiar respuesta de markdown
            textResponse = textResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            const plan = JSON.parse(textResponse);
            return plan;
        }

        function changeTab(tab) {
            appState.currentTab = tab;
            render();
            if (tab === 'chat') {
                setTimeout(() => {
                    const container = document.getElementById('chatContainer');
                    if (container) container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }

        function selectDay(index) {
            appState.selectedDay = index;
            render();
        }

        function selectWeekDay(index) {
            appState.selectedWeekDay = index;
            render();
        }

        function toggleExerciseView(view) {
            appState.exerciseView = view;
            render();
        }

        function toggleNutritionView(view) {
            appState.nutritionView = view;
            render();
        }

        function speakExercise(nombre, series, reps, descanso, descripcion) {
            if ('speechSynthesis' in window) {
                const text = `${nombre}. Realiza ${series} series de ${reps} repeticiones, con ${descanso} de descanso. ${descripcion}`;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                speechSynthesis.speak(utterance);
            } else {
                alert('Tu navegador no soporta s√≠ntesis de voz');
            }
        }

        function toggleShoppingItem(element) {
            element.classList.toggle('checked');
            const checkbox = element.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = !checkbox.checked;
        }

        function setMessage(text) {
            document.getElementById('chatInput').value = text;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            if (!input || !input.value.trim()) return;
            
            const userMessage = input.value;
            appState.chatMessages.push({ role: 'user', content: userMessage });
            input.value = '';
            appState.isLoading = true;
            render();
            
            const apiKey = localStorage.getItem('gemini_api_key');
            
            if (!apiKey) {
                // Respuesta simulada si no hay API key
                setTimeout(() => {
                    const responses = [
                        "¬°Excelente pregunta! Para ese ejercicio, aseg√∫rate de mantener la espalda recta y el core activado. Si sientes dolor, reduce el peso y enf√≥cate primero en la t√©cnica correcta.",
                        "Entiendo tu preocupaci√≥n. Ese alimento puede sustituirse por una opci√≥n similar. ¬øPrefieres algo m√°s espec√≠fico de Mercadona, Aldi o Eroski?",
                        "¬°Muy bien! Para optimizar tus resultados, te recomiendo ajustar ligeramente tu plan. Mant√©n la constancia y ver√°s resultados en pocas semanas.",
                        "Perfecto, puedo ayudarte con eso. Recuerda que la t√©cnica es m√°s importante que el peso. Empieza ligero y ve progresando gradualmente.",
                        "‚ö†Ô∏è Este es un mensaje simulado. Configura tu API key de Gemini en el bot√≥n ‚öôÔ∏è Configurar API para obtener respuestas reales de IA."
                    ];
                    
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    appState.chatMessages.push({ role: 'assistant', content: randomResponse });
                    appState.isLoading = false;
                    render();
                    
                    setTimeout(() => {
                        const container = document.getElementById('chatContainer');
                        if (container) container.scrollTop = container.scrollHeight;
                    }, 100);
                }, 1500);
                return;
            }
            
            // Respuesta real con API de Gemini
            sendMessageWithAI(userMessage, apiKey);
        }

        async function sendMessageWithAI(userMessage, apiKey) {
            try {
                const userData = appState.userData;
                const userPlan = appState.userPlan;
                
                // Crear contexto del usuario
                const equipoTexto = (userData.equipoDisponible || []).join(', ') || 'ninguno';
                const planEjerciciosTexto = userPlan ? JSON.stringify(userPlan.planEjercicios.dias.map(d => ({
                    dia: d.dia,
                    enfoque: d.enfoque,
                    ejercicios: d.ejercicios.map(e => e.nombre)
                }))) : 'no disponible';
                
                const systemContext = `Eres un entrenador personal profesional y nutricionista. 

INFORMACI√ìN DEL USUARIO:
- Nombre: ${userData.nombre}
- Edad: ${userData.edad} a√±os
- Peso: ${userData.peso}kg, Altura: ${userData.altura}cm
- Objetivo: ${userData.objetivo}
- Nivel: ${userData.nivelActividad}
- Entrena: ${userData.diasSemana} d√≠as/semana en ${userData.lugarEntrenamiento}
- Equipo disponible: ${equipoTexto}
- Lesiones: ${userData.lesiones || 'ninguna'}

PLAN ACTUAL:
${planEjerciciosTexto}

INSTRUCCIONES:
- Responde de forma cercana, motivadora y profesional
- Usa el nombre del usuario cuando sea apropiado
- Da consejos espec√≠ficos basados en su plan y equipo
- Si pregunta por ejercicios, explica la t√©cnica detalladamente
- Si pregunta por nutrici√≥n, recomienda productos de Mercadona/Aldi/Eroski
- Si quiere modificar algo, explica alternativas viables con su equipo
- S√© conciso pero completo (m√°ximo 200 palabras por respuesta)
- Usa emojis ocasionalmente para mantener el tono amigable`;

                // Construir historial de conversaci√≥n
                const conversationHistory = appState.chatMessages.slice(-10).map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                }));
                
                // A√±adir mensaje del sistema al inicio
                conversationHistory.unshift({
                    role: 'user',
                    parts: [{ text: systemContext }]
                });
                conversationHistory.push({
                    role: 'model',
                    parts: [{ text: 'Entendido. Estoy listo para ayudarte como tu entrenador personal.' }]
                });

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: conversationHistory,
                        generationConfig: {
                            temperature: 0.9,
                            maxOutputTokens: 500
                        }
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Error en la API');
                }

                const aiResponse = data.candidates[0].content.parts[0].text;
                appState.chatMessages.push({ role: 'assistant', content: aiResponse });
                appState.isLoading = false;
                render();
                
                setTimeout(() => {
                    const container = document.getElementById('chatContainer');
                    if (container) container.scrollTop = container.scrollHeight;
                }, 100);
                
            } catch (error) {
                console.error('Error sending message:', error);
                appState.chatMessages.push({ 
                    role: 'assistant', 
                    content: '‚ùå Error al conectar con la IA. Por favor verifica tu API key o intenta de nuevo.' 
                });
                appState.isLoading = false;
                render();
            }
        }

        // Iniciar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedData();
            checkAndResetDailyTracking();
            setupKeyboardNavigation();
            render();
        });

        // Navegaci√≥n por teclado en tabs (ARIA)
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                const tabs = document.querySelectorAll('[role="tab"]');
                if (tabs.length === 0) return;
                
                const currentTab = document.activeElement;
                if (currentTab.getAttribute('role') !== 'tab') return;
                
                const tabsArray = Array.from(tabs);
                const currentIndex = tabsArray.indexOf(currentTab);
                let newIndex = currentIndex;
                
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    newIndex = (currentIndex + 1) % tabs.length;
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                } else if (e.key === 'Home') {
                    e.preventDefault();
                    newIndex = 0;
                } else if (e.key === 'End') {
                    e.preventDefault();
                    newIndex = tabs.length - 1;
                }
                
                if (newIndex !== currentIndex) {
                    tabs[newIndex].focus();
                    tabs[newIndex].click();
                }
            });
        }

        // Mostrar errores de formulario con aria-live
        function showFormError(message) {
            const errorEl = document.getElementById('formErrors');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                
                // Auto-ocultar despu√©s de 5 segundos
                setTimeout(() => {
                    errorEl.classList.add('hidden');
                }, 5000);
            } else {
                alert(message);
            }
        }
    </script>
</body>
</html>
