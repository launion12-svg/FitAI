<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>FitAI ‚Äì Tu entrenador personal</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f43f5e"/>
  <style>
    :root{ --pri:#f43f5e; --pri2:#fb923c; --bg:#f5f5f5; --fg:#333; --card:#fff; --muted:#666;
           --pill:#f0f0f0; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --shadow:0 2px 10px rgba(0,0,0,.1); }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#121212; --fg:#f5f5f5; --card:#1e1e1e; --pill:#2a2a2a; --shadow:0 2px 10px rgba(0,0,0,.4); }
    }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:var(--bg);color:var(--fg);}
    .hidden{display:none!important}
    .dashboard-header{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;padding:14px 16px;position:sticky;top:0;z-index:10}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .dashboard-header h1{margin:0;font-size:18px}
    .header-actions{display:flex;gap:8px}
    .hdr-btn{border:none;border-radius:10px;padding:8px 10px;background:rgba(255,255,255,.18);color:#fff;cursor:pointer;font-weight:700}
    .tabs{display:flex;gap:6px;overflow-x:auto;background:var(--card);border-bottom:1px solid rgba(0,0,0,.07);position:sticky;top:56px;z-index:5}
    .tab{padding:12px 14px;border:none;background:none;color:var(--fg);cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap}
    .tab.active{border-bottom-color:var(--pri);font-weight:700;color:var(--pri)}
    .dashboard-content{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px;margin:12px 0}
    .card h2{margin:0 0 10px 0;font-size:20px;display:flex;align-items:center;gap:8px}
    .card h3{margin:0 0 8px 0}
    .macro-card{border-radius:10px;padding:12px;text-align:center}
    .macro-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .macro-value{font-weight:800;font-size:24px}
    .macro-label{opacity:.85}
    .btn{border:none;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff}
    .btn-secondary{background:var(--pill);color:var(--fg);border:1px solid rgba(0,0,0,.08)}
    .btn-ghost{background:transparent;color:var(--muted)}
    .food-store{background:var(--pill);padding:4px 10px;border-radius:999px;font-size:12px}
    .date-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .date-row input{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.12);background:var(--pill);color:var(--fg)}
    .chat-container{height:360px;overflow:auto;background:var(--pill);border-radius:10px;padding:12px}
    .chat-message{display:flex;margin:10px 0}
    .message-bubble{max-width:80%;padding:10px 14px;border-radius:14px;background:var(--card)}
    .chat-message.user{justify-content:flex-end}
    .chat-message.user .message-bubble{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;z-index:2000}
    .toast.show{animation:tshow .18s ease forwards,thide .18s ease forwards 2.4s}
    @keyframes tshow{to{opacity:1;transform:translateX(-50%) translateY(-6px)}}
    @keyframes thide{to{opacity:0;transform:translateX(-50%) translateY(10px)}}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1500}
    .overlay.show{display:flex}
    .modal{width:min(720px,92vw);max-height:82vh;overflow:auto;background:var(--card);color:var(--fg);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .modal header{padding:16px;border-bottom:1px solid rgba(0,0,0,.08);display:flex;align-items:center;justify-content:space-between}
    .modal h3{margin:0;font-size:18px}
    .modal .content{padding:16px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-weight:700;font-size:12px;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.12);background:var(--pill);color:var(--fg)}
    .logger-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .set-input{width:84px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,.12);background:var(--pill);text-align:center}
    .pill{border-radius:999px;padding:6px 10px;background:var(--pill);display:inline-block}
    .bar{height:10px;background:var(--pill);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--pri),var(--pri2));width:0%}
    .exercise-item{border:1px solid rgba(0,0,0,.08);border-radius:10px;padding:12px;margin:10px 0}
    .exercise-header{display:flex;justify-content:space-between;align-items:center}
    .exercise-number{background:var(--pri);color:#fff;border-radius:999px;padding:4px 10px;font-weight:800}
    .exercise-name{font-weight:800}
  </style>
</head>
<body>
  <header class="dashboard-header">
    <div class="header-row">
      <h1>FitAI ‚Äì Tu entrenador personal</h1>
      <div class="header-actions" aria-label="Acciones">
        <button id="btnHistory" class="hdr-btn" aria-haspopup="dialog" title="Historial">üìú</button>
        <button id="btnProfile" class="hdr-btn" aria-haspopup="dialog" title="Perfil">üë§</button>
        <button id="btnSettings" class="hdr-btn" aria-haspopup="dialog" title="Configuraci√≥n">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Secciones">
    <button class="tab active" role="tab" aria-selected="true" data-tab="plan">Plan</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="nutricion">Nutrici√≥n</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="chat">Chat</button>
    <button class="tab" role="tab" aria-selected="false" data-tab="progreso">Progreso</button>
  </nav>

  <main class="dashboard-content">
    <section class="card" data-panel="plan" aria-labelledby="ai-plan-title">
      <h2 id="ai-plan-title">ü§ñ Plan personalizado por IA
        <span id="aiModeBadge" class="food-store">IA: Demo</span>
      </h2>
      <div style="display:flex;gap:8px;margin:8px 0;flex-wrap:wrap">
        <button id="btnRecalcPlan" class="btn btn-primary">Actualizar mi plan</button>
        <button id="btnDemoPlan" class="btn btn-secondary">Restaurar plan demo</button>
        <button id="btnSaveVersion" class="btn btn-secondary">Guardar versi√≥n</button>
        <span id="aiPlanStamp" class="macro-label" aria-live="polite"></span>
      </div>

      <div class="card">
        <div class="date-row">
          <label for="datePlan">üìÖ D√≠a</label>
          <input id="datePlan" type="date"/>
          <button id="btnToday" class="btn btn-ghost">Hoy</button>
        </div>
        <h3>Entrenamiento (7 d√≠as)</h3>
        <div id="aiWorkoutPlan"></div>
      </div>
      <div class="card">
        <h3>Registro de entrenamiento (<span id="logDayLabel">hoy</span>)</h3>
        <div id="workoutLogger"></div>
        <div class="logger-row">
          <span class="pill">Series hechas: <b id="setsDone">0</b></span>
          <span class="pill">Volumen: <b id="tonnage">0 kg</b></span>
        </div>
      </div>

      <div class="card">
        <h3>Nutrici√≥n (d√≠a tipo)</h3>
        <div id="aiNutritionPlan"></div>
      </div>
    </section>

    <section class="card hidden" data-panel="nutricion">
      <h2>üçΩÔ∏è Registro de comida</h2>
      <div class="date-row">
        <label for="dateNutri">üìÖ D√≠a</label>
        <input id="dateNutri" type="date"/>
        <button id="btnNutriToday" class="btn btn-ghost">Hoy</button>
        <button id="btnExportDay" class="btn btn-secondary">Exportar d√≠a</button>
        <button id="btnImport" class="btn btn-secondary">Importar</button>
        <input id="fileImport" type="file" accept="application/json" class="hidden"/>
        <button id="btnExportAll" class="btn btn-secondary">Exportar todo</button>
      </div>
      <div class="card" style="margin-top:8px">
        <h3>Resumen diario</h3>
        <div class="logger-row">
          <span class="pill">Adherencia nutrici√≥n: <b id="adhNutrition">0%</b></span>
          <span class="pill">Adherencia entrenamiento: <b id="adhTraining">0%</b></span>
          <span class="pill">Agua: <b id="waterNow">0</b> ml</span>
          <span class="pill">Pasos: <b id="stepsNow">0</b></span>
        </div>
        <div class="logger-row">
          <div class="bar" style="flex:1"><span id="adhBar"></span></div>
          <span class="pill">Global: <b id="adhGlobal">0%</b></span>
        </div>
        <p class="macro-label">Criterios: kcal ¬±10% del objetivo y prote√≠na ‚â• 90%; entreno: ‚â•12 sets/d√≠a (heur√≠stico).</p>
      </div>
      <div class="macro-grid" id="macroTargets"></div>
      <div class="logger-row">
        <span>Consumido kcal</span>
        <div class="bar" style="flex:1"><span id="kcalBar"></span></div>
        <span class="pill"><b id="kcalNow">0</b> / <span id="kcalGoal">0</span> kcal</span>
      </div>
      <div class="logger-row">
        <span>Prote√≠na</span>
        <div class="bar" style="flex:1"><span id="proBar"></span></div>
        <span class="pill"><b id="proNow">0</b> / <span id="proGoal">0</span> g</span>
      </div>
      <div id="nutritionList"></div>
      <div class="card">
        <h3>Agua y pasos</h3>
        <div class="logger-row">
          <button id="btnWaterMinus" class="btn btn-secondary">-250 ml</button>
          <span class="pill">Agua: <b id="waterNow2">0</b> ml</span>
          <button id="btnWaterPlus" class="btn btn-primary">+250 ml</button>
        </div>
        <div class="logger-row">
          <label>Pasos hoy</label>
          <input id="stepsInput" class="set-input" type="number" min="0" step="100" placeholder="0"/>
          <button id="btnSaveSteps" class="btn btn-secondary">Guardar</button>
        </div>
      </div>
    </section>

    <section class="card hidden" data-panel="chat">
      <h2>üí¨ Asistente FitAI <span id="chatIaBadge" class="food-store">IA: Demo</span></h2>
      <div class="quick-questions">
        <button class="quick-btn">C√°mbiame el salm√≥n por algo sin pescado</button>
        <button class="quick-btn">No puedo hacer sentadilla, dame alternativa</button>
        <button class="quick-btn">Plan de 3 d√≠as para perder grasa</button>
      </div>
      <div class="chat-container" id="chatBox"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input class="chat-input" placeholder="Escribe aqu√≠..." style="flex:1;padding:10px;border-radius:999px;border:1px solid rgba(0,0,0,.12)"/>
        <button class="send-btn btn btn-primary">Enviar</button>
      </div>
    </section>

    <section class="card hidden" data-panel="progreso">
      <h2>üìä Progreso</h2>
      <p class="macro-label">Pr√≥ximo sprint: gr√°ficas con Chart.js</p>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="overlay" class="overlay" role="none presentation" aria-hidden="true"></div>

  <template id="tpl-modal-settings">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <header>
        <h3 id="settings-title">‚öôÔ∏è Configuraci√≥n</h3>
        <button class="hdr-btn" data-close="true">‚úñ</button>
      </header>
      <div class="content">
        <p>Exporta o importa tus datos en <b>Nutrici√≥n ‚Üí Exportar/Importar</b>.</p>
        <p>Selector de fecha disponible en Plan y Nutrici√≥n.</p>
      </div>
      <footer>
        <button class="btn btn-secondary" data-close="true">Cerrar</button>
      </footer>
    </div>
  </template>

  <script>
    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const k = btn.dataset.tab;
      document.querySelectorAll('[data-panel]').forEach(p=>p.classList.toggle('hidden', p.dataset.panel!==k));
    }));

    // Toast
    window.FitAI = window.FitAI || {};
    FitAI.toast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2600); };

    // Modal settings
    const overlay = document.getElementById('overlay');
    function openModal(tplId){
      const tpl = document.getElementById(tplId);
      overlay.innerHTML = '';
      overlay.appendChild(tpl.content.cloneNode(true));
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
      overlay.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', closeModal));
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); }, {once:true});
      document.addEventListener('keydown', onEsc, {once:true});
    }
    function closeModal(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); overlay.innerHTML=''; }
    function onEsc(e){ if(e.key==='Escape') closeModal(); }
    document.getElementById('btnSettings').addEventListener('click', ()=> openModal('tpl-modal-settings'));

    // Storage
    const SKEY_STATE   = 'fitai.state.v3';
    const SKEY_PLAN    = 'fitai.plan.v1';
    const SKEY_HISTORY = 'fitai.planHistory.v1';
    const SKEY_LOG     = 'fitai.log.v1';
    function load(key, def=null){ try{ return JSON.parse(localStorage.getItem(key) ?? 'null') ?? def; }catch{return def;} }
    function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    // Date helpers
    function fmtDate(d){ return d.toISOString().slice(0,10); }
    let currentDate = fmtDate(new Date());
    const inpPlanDate = document.getElementById('datePlan');
    const inpNutriDate = document.getElementById('dateNutri');
    inpPlanDate.value = currentDate;
    inpNutriDate.value = currentDate;
    document.getElementById('btnToday').onclick = ()=>{ currentDate = fmtDate(new Date()); inpPlanDate.value = currentDate; renderAll(); };
    document.getElementById('btnNutriToday').onclick = ()=>{ currentDate = fmtDate(new Date()); inpNutriDate.value = currentDate; renderAll(); };
    inpPlanDate.addEventListener('change', e=>{ currentDate = e.target.value; renderAll(); });
    inpNutriDate.addEventListener('change', e=>{ currentDate = e.target.value; renderAll(); });
    function todayKey(){ return currentDate; }
    function getLog(dateKey=todayKey()){ const lg=load(SKEY_LOG, {}); return lg[dateKey] || { setsDone:0, tonnage:0, kcal:0, protein:0, water:0, steps:0, mealsTaken:{} }; }
    function setLog(partial, dateKey=todayKey()){ const lg=load(SKEY_LOG, {}); lg[dateKey] = Object.assign(getLog(dateKey), partial); save(SKEY_LOG, lg); renderDailyStats(); }

    function getProfile(){ const st = load(SKEY_STATE, {}); return st.profile || { weight_kg:75, goal:'perder grasa', days_per_week:3, equipment:'gimnasio', allergies:[], injuries:[], preference:'ninguna', level:'principiante' }; }

    // Plan (heur√≠stico + IA)
    function heuristicPlan(profile){
      const p = profile || {};
      const w = p.weight_kg || 75;
      const goal = (p.goal||'perder').toLowerCase();
      let kcal = Math.round( (goal.includes('perder')? 26 : goal.includes('ganar')? 32 : 28) * w );
      if (p.level==='avanzado') kcal += 100;
      if (p.level==='principiante' && goal.includes('perder')) kcal -= 100;
      const protein = Math.round(w * (goal.includes('ganar')? 2.0 : 1.7));
      const carbs   = Math.round((kcal*0.45)/4);
      const fat     = Math.round((kcal*0.30)/9);
      const avoidFish = (p.allergies||[]).some(a=>/pescad|marisco|at[u√∫]n|salm[o√≥]n/i.test(a));
      const baseMeals = [
        { time:'Desayuno', items:['Avena 60g','Yogur griego 200g','Pl√°tano 1'], kcal: Math.round(kcal*0.25), protein: Math.round(protein*0.25) },
        { time:'Comida',   items:['Arroz 90g','Pechuga 180g','Verduras 200g','Aceite 10g'], kcal: Math.round(kcal*0.35), protein: Math.round(protein*0.35) },
        { time:'Merienda', items:['Pan 80g','At√∫n 100g','Tomate'], kcal: Math.round(kcal*0.15), protein: Math.round(protein*0.15) },
        { time:'Cena',     items:['Pasta 80g', (avoidFish?'Tofu 150g':'Salm√≥n 150g'),'Ensalada','Aceite 10g'], kcal: Math.round(kcal*0.25), protein: Math.round(protein*0.25) },
      ];
      if (avoidFish){ baseMeals[2].items = ['Pan 80g','Hummus 60g','Tomate']; }
      if ((p.preference||'').includes('veg') ){ baseMeals[1].items = ['Arroz 90g','Tofu 200g','Verduras 200g','Aceite 10g']; }

      const days = Math.min(Math.max(p.days_per_week||3,1),7);
      const full = ['Full Body','Full Body','Full Body','Descanso','Full Body','Descanso','Descanso'];
      const pushpulllegs = ['Pecho/Hombro/Tr√≠ceps','Espalda/B√≠ceps','Piernas','Descanso','Full Body','Descanso','Descanso'];
      const split = days>=4 ? pushpulllegs : full;

      const ex = {
        'Pecho/Hombro/Tr√≠ceps': p.equipment==='gimnasio'
          ? ['Press banca','Press militar','Fondos','Aperturas','Tr√≠ceps polea']
          : ['Flexiones','Press mancuernas','Fondos en banco','Aperturas mancuernas','Extensi√≥n banda'],
        'Espalda/B√≠ceps': p.equipment==='gimnasio'
          ? ['Dominadas','Remo con barra','Jal√≥n polea','Facepull','Curl b√≠ceps']
          : ['Remo con mancuernas','Dominadas asistidas','Jal√≥n con banda','P√°jaro','Curl mancuernas'],
        'Piernas': p.equipment==='gimnasio'
          ? ['Sentadilla','Peso muerto rumano','Prensa','Zancadas','Gemelos']
          : ['Sentadilla goblet','Hip thrust','Zancadas','Puente gl√∫teo','Gemelos'],
        'Full Body': ['Sentadilla goblet','Push-up','Remo mancuerna','Plancha','Hip thrust'],
      };
      const workout = split.map((name, i) => name==='Descanso'
        ? { day:i+1, rest:true, exercises:[], notes:'Caminar 30 min + movilidad' }
        : { day:i+1, name, exercises: ex[name]||ex['Full Body'] });

      return { meta:{ generatedAt:new Date().toISOString(), engine:'heuristic' },
        profile: p, targets:{ kcal, protein, carbs, fat }, workout, meals: baseMeals };
    }

    async function callGeminiPlan(profile){
      try{
        const system='Eres un entrenador personal y nutricionista. Responde SOLO JSON v√°lido.';
        const schema='{"targets":{"kcal":number,"protein":number,"carbs":number,"fat":number},"workout":[{"day":1-7,"name":string,"rest"?:boolean,"exercises":string[]}],"meals":[{"time":string,"items":string[],"kcal":number,"protein":number}]}';
        const input = 'Datos de perfil:\n'+JSON.stringify(profile)+'\n\nDevuelve SOLO JSON con este esquema:\n'+schema+'\nRespeta alergias, lesiones y preferencias.';
        const res = await fetch('/api/gemini',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({input,system})});
        if(!res.ok) throw 0;
        const data = await res.json();
        const text = (data?.output||'').trim();
        const plan = JSON.parse(text);
        plan.meta = Object.assign({}, plan.meta||{}, { generatedAt:new Date().toISOString(), engine:'gemini' });
        plan.profile = profile;
        return plan;
      }catch(e){ return heuristicPlan(profile); }
    }

    function renderPlan(plan){
      const stamp = document.getElementById('aiPlanStamp');
      if (stamp) stamp.textContent = plan?.meta?.generatedAt ? ('Actualizado: ' + new Date(plan.meta.generatedAt).toLocaleString()) : '';
      const w = document.getElementById('aiWorkoutPlan');
      const n = document.getElementById('aiNutritionPlan');
      if (w){
        w.innerHTML = '';
        (plan.workout||[]).forEach(d => {
          const box = document.createElement('div');
          box.className = 'exercise-item' + (d.rest?' exercise-completed':'');
          if (d.rest){
            box.innerHTML = `<div class="exercise-header"><span class="exercise-number">D√≠a ${d.day}</span><div class="exercise-name">Descanso activo</div></div><div class="exercise-details">Caminar 30 min + movilidad</div>`;
          } else {
            box.innerHTML = `
              <div class="exercise-header">
                <span class="exercise-number">D√≠a ${d.day}</span>
                <div class="exercise-name">${d.name||'Entrenamiento'}</div>
              </div>
              <div class="exercise-details">${(d.exercises||[]).map(x=>`
                <div class="detail-item" style="display:flex;align-items:center;gap:6px;margin:4px 0">
                  <span class="food-name">${x}</span>
                  <button class="btn btn-secondary" onclick="requestExerciseSwap('${x}')">Sustituir</button>
                  <button class="btn btn-primary" onclick="window.showExerciseGuide ? window.showExerciseGuide('${x}') : null">‚ÑπÔ∏è Gu√≠a</button>
                </div>`).join('')}</div>`;
          }
          w.appendChild(box);
        });
        renderWorkoutLogger((plan.workout||[]).find(d=>!d.rest)?.exercises||[]);
      }
      if (n){
        n.innerHTML = '';
        const t = plan.targets||{};
        const macros = document.createElement('div');
        macros.className = 'macro-grid';
        macros.innerHTML = `
          <div class="macro-card" style="background:#fee2e2;color:#b91c1c"><div class="macro-value">${Math.round(t.kcal||0)}</div><div class="macro-label">kcal/d√≠a</div></div>
          <div class="macro-card" style="background:#dbeafe;color:#2563eb"><div class="macro-value">${Math.round(t.protein||0)}g</div><div class="macro-label">Prote√≠nas</div></div>
          <div class="macro-card" style="background:#d1fae5;color:#059669"><div class="macro-value">${Math.round(t.carbs||0)}g</div><div class="macro-label">Carbohidratos</div></div>
          <div class="macro-card" style="background:#fef3c7;color:#d97706"><div class="macro-value">${Math.round(t.fat||0)}g</div><div class="macro-label">Grasas</div></div>`;
        n.appendChild(macros);
        (plan.meals||[]).forEach((m, idx)=>{
          const meal=document.createElement('div'); meal.className='meal-item'; meal.style.border='1px solid rgba(0,0,0,.08)'; meal.style.borderRadius='10px'; meal.style.padding='10px'; meal.style.margin='8px 0';
          const key = 'meal_'+idx+'_'+todayKey();
          meal.innerHTML = `<div class="meal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <div class="meal-name" style="font-weight:800">${m.time}</div>
              <div class="meal-calories food-store">${m.kcal} kcal ¬∑ ${m.protein||0} g prot</div>
            </div>
            <div class="food-list">${(m.items||[]).map(x=>`<div class="food-item" style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(0,0,0,.06)">
              <span class="food-name">${x}</span>
              <span>
                <button class="btn btn-secondary" onclick="requestFoodSwap('${x.replace("'", "\'")}')">Sustituir</button>
              </span>
            </div>`).join('')}</div>
            <div class="logger-row">
              <label><input type="checkbox" onchange="toggleMealTaken('${key}', ${m.kcal}, ${m.protein||0})"/> Marcar tomada</label>
            </div>`;
          n.appendChild(meal);
        });
      }
      window._currentPlan = plan;
      save(SKEY_PLAN, plan);
      const el=document.getElementById('aiModeBadge'); if(el) el.textContent = plan.meta.engine==='gemini'?'IA: Activa':'IA: Demo';
      renderDailyStats();
    }

    function renderWorkoutLogger(list){
      const box = document.getElementById('workoutLogger'); if(!box) return;
      const log = getLog();
      box.innerHTML = '';
      list.forEach(name=>{
        const row = document.createElement('div');
        row.className = 'logger-row';
        row.innerHTML = `
          <span class="pill" style="min-width:140px">${name}</span>
          <input class="set-input" type="number" min="1" step="1" placeholder="Series" aria-label="Series para ${name}"/>
          <input class="set-input" type="number" min="1" step="1" placeholder="Reps" aria-label="Reps para ${name}"/>
          <input class="set-input" type="number" min="0" step="2.5" placeholder="Peso (kg)" aria-label="Peso para ${name}"/>
          <button class="btn btn-secondary">A√±adir set</button>
        `;
        const btn = row.querySelector('button.btn.btn-secondary');
        const [inpS, inpR, inpW] = row.querySelectorAll('input');
        btn.addEventListener('click', ()=>{
          const s = parseInt(inpS.value||'1'); const r = parseInt(inpR.value||'8'); const w = parseFloat(inpW.value||'0');
          const addSets = isFinite(s)&&s>0 ? s : 1;
          const reps    = isFinite(r)&&r>0 ? r : 8;
          const weight  = isFinite(w)&&w>=0 ? w : 0;
          const done = (getLog().setsDone||0) + addSets;
          const ton  = (getLog().tonnage||0) + (addSets*reps*weight);
          setLog({ setsDone: done, tonnage: Math.round(ton) });
          FitAI.toast('Set a√±adido ‚úÖ');
        });
        box.appendChild(row);
      });
      document.getElementById('setsDone').textContent = log.setsDone||0;
      document.getElementById('tonnage').textContent = Math.round(log.tonnage||0) + ' kg';
      document.getElementById('logDayLabel').textContent = todayKey();
    }

    // Meal toggles + daily stats
    function toggleMealTaken(key, kcal, protein){
      const log = getLog();
      const taken = log.mealsTaken || {};
      const isNow = !taken[key];
      taken[key] = isNow ? 1 : 0;
      const kcalNow = (log.kcal||0) + (isNow ? kcal : -kcal);
      const proNow  = (log.protein||0) + (isNow ? (protein||0) : -(protein||0));
      setLog({ mealsTaken: taken, kcal: Math.max(0,kcalNow), protein: Math.max(0,proNow) });
      FitAI.toast(isNow?'Comida registrada üçΩÔ∏è':'Comida desmarcada');
    }

    function renderDailyStats(){
      const plan = JSON.parse(localStorage.getItem(SKEY_PLAN)||'null') || {};
      const t = plan.targets||{kcal:0, protein:0};
      const log = getLog();
      const kcalNow = Math.round(log.kcal||0), kcalGoal = Math.round(t.kcal||0);
      const proNow  = Math.round(log.protein||0), proGoal = Math.round(t.protein||0);
      const kcalPct = kcalGoal? Math.min(100, Math.round((kcalNow*100)/kcalGoal)) : 0;
      const proPct  = proGoal?  Math.min(100, Math.round((proNow*100)/proGoal))   : 0;
      const kcalBar = document.getElementById('kcalBar'); if(kcalBar){ kcalBar.style.width = kcalPct+'%'; }
      const proBar  = document.getElementById('proBar');  if(proBar){ proBar.style.width  = proPct+'%'; }
      const kcalNowEl=document.getElementById('kcalNow'); if(kcalNowEl){ kcalNowEl.textContent = kcalNow; }
      const kcalGoalEl=document.getElementById('kcalGoal'); if(kcalGoalEl){ kcalGoalEl.textContent = kcalGoal; }
      const proNowEl=document.getElementById('proNow'); if(proNowEl){ proNowEl.textContent = proNow; }
      const proGoalEl=document.getElementById('proGoal'); if(proGoalEl){ proGoalEl.textContent = proGoal; }

      const waterNow1=document.getElementById('waterNow'); if(waterNow1){ waterNow1.textContent = log.water||0; }
      const waterNow2=document.getElementById('waterNow2'); if(waterNow2){ waterNow2.textContent = log.water||0; }
      const stepsNow=document.getElementById('stepsNow'); if(stepsNow){ stepsNow.textContent = log.steps||0; }

      // Adherencia (heur√≠stica simple)
      const nutriScore = (kcalGoal? Math.max(0, 1 - Math.abs(kcalNow-kcalGoal)/kcalGoal) : 0) * 0.5
                       + (proGoal? Math.min(1, proNow/(proGoal)) : 0) * 0.5;
      const setsGoal = 12;
      const trainScore = Math.min(1, (getLog().setsDone||0) / setsGoal);
      const adhN = Math.round(nutriScore*100);
      const adhT = Math.round(trainScore*100);
      const adhG = Math.round(adhN*0.7 + adhT*0.3);
      const adhNEl=document.getElementById('adhNutrition'); if(adhNEl){ adhNEl.textContent = adhN+'%'; }
      const adhTEl=document.getElementById('adhTraining'); if(adhTEl){ adhTEl.textContent = adhT+'%'; }
      const adhGEl=document.getElementById('adhGlobal'); if(adhGEl){ adhGEl.textContent = adhG+'%'; }
      const adhBar=document.getElementById('adhBar'); if(adhBar){ adhBar.style.width = adhG+'%'; }
    }

    // Water & steps
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id==='btnWaterPlus'){ const v=(getLog().water||0)+250; setLog({water:v}); FitAI.toast('+250 ml üíß'); }
      if (e.target && e.target.id==='btnWaterMinus'){ const v=Math.max(0,(getLog().water||0)-250); setLog({water:v}); FitAI.toast('-250 ml'); }
      if (e.target && e.target.id==='btnSaveSteps'){ const input=document.getElementById('stepsInput'); const v=parseInt(input?.value||'0')||0; setLog({steps:Math.max(0,v)}); FitAI.toast('Pasos guardados üö∂'); }
    });

    // Export / Import
    document.getElementById('btnExportDay').addEventListener('click', ()=>{
      const key = todayKey();
      const data = getLog();
      const blob = new Blob([JSON.stringify({ [key]: data }, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'fitai-day-'+key+'.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    });
    document.getElementById('btnExportAll').addEventListener('click', ()=>{
      const all = JSON.parse(localStorage.getItem(SKEY_LOG) || '{}');
      const blob = new Blob([JSON.stringify(all, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'fitai-all.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    });
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileImport').click());
    document.getElementById('fileImport').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const parsed = JSON.parse(String(reader.result||'{}'));
          const base = JSON.parse(localStorage.getItem(SKEY_LOG) || '{}');
          const merged = Object.assign(base, parsed);
          localStorage.setItem(SKEY_LOG, JSON.stringify(merged));
          FitAI.toast('Importado correctamente ‚úÖ');
          renderAll();
        }catch{ FitAI.toast('Archivo inv√°lido'); }
      };
      reader.readAsText(f);
      e.target.value='';
    });

    // Sustituciones demo
    window.requestExerciseSwap = function(currentName){
      const plan = JSON.parse(localStorage.getItem(SKEY_PLAN)||'null'); if(!plan) return;
      (plan.workout||[]).forEach(d=>{
        if (d.rest) return;
        d.exercises = (d.exercises||[]).map(x=> x===currentName ? (currentName==='Sentadilla'?'Prensa':'Sentadilla goblet') : x);
      });
      plan.meta.modifiedAt = new Date().toISOString();
      localStorage.setItem(SKEY_PLAN, JSON.stringify(plan)); renderPlan(plan);
      FitAI.toast('Sustituido por alternativa segura ‚úÖ');
    };
    window.requestFoodSwap = function(currentItem){
      const plan = JSON.parse(localStorage.getItem(SKEY_PLAN)||'null'); if(!plan) return;
      (plan.meals||[]).forEach(m=>{
        m.items = (m.items||[]).map(x=> x.toLowerCase().includes(currentItem.toLowerCase()) ? 'Tofu 150g' : x);
      });
      plan.meta.modifiedAt = new Date().toISOString();
      localStorage.setItem(SKEY_PLAN, JSON.stringify(plan)); renderPlan(plan);
      FitAI.toast('Sustituido por equivalente nutricional ‚úÖ');
    };

    // Chat demo + IA
    function setChatMode(mode){ const b=document.getElementById('chatIaBadge'); if(b) b.textContent = (mode==='ai'?'IA: Activa':mode==='error'?'IA: Error':'IA: Demo'); }
    function addChatMessage(role, text){
      const box=document.getElementById('chatBox'); if(!box) return;
      const wrap=document.createElement('div'); wrap.className='chat-message ' + (role==='user'?'user':'assistant');
      const bubble=document.createElement('div'); bubble.className='message-bubble'; bubble.textContent=text; wrap.appendChild(bubble);
      box.appendChild(wrap); box.scrollTop=box.scrollHeight;
    }
    async function chatGemini(prompt, {timeoutMs=15000}={}){
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
      const res=await fetch('/api/gemini',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({input:prompt,system:'Eres un entrenador y nutricionista en espa√±ol. S√© claro y motivador.'}),signal:ctrl.signal}).catch(()=>null);
      clearTimeout(t); if(!res||!res.ok) return;
      const data=await res.json().catch(()=>null);
      const text=(data?.output||'').trim(); if(!text) return;
      setChatMode('ai'); addChatMessage('assistant', text);
    }
    document.addEventListener('click', (e)=>{ if(e.target && e.target.classList.contains('send-btn')){
      const input=document.querySelector('.chat-input'); if(!input) return; const text=input.value.trim(); if(!text) return;
      addChatMessage('user', text); input.value=''; addChatMessage('assistant','üí¨ Hoy c√©ntrate en la constancia, no en la perfecci√≥n.'); chatGemini(text);
    }});

    // Actions: recalc/restore/save
    async function recalcPlan(){
      const profile = getProfile();
      const plan = await callGeminiPlan(profile);
      localStorage.setItem(SKEY_PLAN, JSON.stringify(plan));
      renderPlan(plan);
      FitAI.toast(plan.meta.engine==='gemini'?'Plan actualizado con IA ü§ñ':'Modo demo sin IA (plan de ejemplo)');
    }
    function restoreDemo(){
      const profile = getProfile();
      const demo = heuristicPlan(profile);
      localStorage.setItem(SKEY_PLAN, JSON.stringify(demo));
      renderPlan(demo);
      FitAI.toast('Plan de ejemplo restaurado');
    }
    function saveVersion(){
      const plan = JSON.parse(localStorage.getItem(SKEY_PLAN) || 'null'); if(!plan){ FitAI.toast('No hay plan para guardar'); return; }
      const items = JSON.parse(localStorage.getItem(SKEY_HISTORY) || '[]');
      const entry = { ts: Date.now(), engine: plan?.meta?.engine || 'demo', kcal: plan?.targets?.kcal || 0, protein: plan?.targets?.protein || 0, days: (plan?.workout||[]).filter(x=>!x.rest).length };
      items.unshift({ meta: entry, plan });
      localStorage.setItem(SKEY_HISTORY, JSON.stringify(items.slice(0,10)));
      FitAI.toast('Versi√≥n guardada en historial ‚úÖ');
    }
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id==='btnRecalcPlan') recalcPlan();
      if (e.target && e.target.id==='btnDemoPlan') restoreDemo();
      if (e.target && e.target.id==='btnSaveVersion') saveVersion();
    });

    function renderAll(){
      const saved = JSON.parse(localStorage.getItem(SKEY_PLAN) || 'null');
      if (saved) renderPlan(saved); else restoreDemo();
    }
    (function init(){ renderAll(); })();

    // PWA
    if ('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
